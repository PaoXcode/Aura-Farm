<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Aura Farm V3</title>
  <style>
    :root{--bg:#050505;--t:#f7f7f7;--m:#b8b8b8;--g:#d4af37;--g2:#ffd56a;--b:rgba(212,175,55,.28);--sh:rgba(0,0,0,.78)}
    *{box-sizing:border-box}
    body{margin:0;padding:14px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI;background:
      radial-gradient(900px 520px at 20% 0%,rgba(212,175,55,.10),transparent 60%),
      radial-gradient(800px 520px at 80% 10%,rgba(255,213,106,.08),transparent 55%),
      var(--bg);
      color:var(--t);letter-spacing:.01em}
    .wrap{max-width:920px;margin:0 auto}
    .top{position:sticky;top:0;z-index:3;backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(5,5,5,.92),rgba(5,5,5,.55));border:1px solid rgba(255,213,106,.22);border-radius:18px;padding:12px 14px;box-shadow:0 18px 40px var(--sh);margin-bottom:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .sig{width:38px;height:38px;border-radius:12px;display:grid;place-items:center;font-weight:900;color:var(--g2);border:1px solid rgba(212,175,55,.55);background:radial-gradient(circle at 30% 30%,rgba(255,213,106,.55),rgba(212,175,55,.12) 55%,rgba(212,175,55,.05));box-shadow:0 0 24px rgba(212,175,55,.15)}
    .title{font-size:18px;font-weight:900;letter-spacing:.06em;text-transform:uppercase;background:linear-gradient(90deg,var(--g2),var(--g),var(--g2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .sub{margin-top:2px;font-size:12px;color:var(--m)}
    .pill{border:1px solid rgba(212,175,55,.35);background:rgba(212,175,55,.08);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--g2);white-space:nowrap}
    .btn{appearance:none;border:1px solid rgba(212,175,55,.35);background:rgba(17,17,17,.86);color:var(--t);padding:9px 12px;border-radius:999px;font-weight:900;cursor:pointer;transition:transform .08s ease,box-shadow .18s ease,border-color .18s ease,background .18s ease;box-shadow:0 0 0 1px rgba(212,175,55,.10),0 18px 40px rgba(0,0,0,.55)}
    .btn:hover{border-color:rgba(255,213,106,.65);box-shadow:0 0 0 1px rgba(255,213,106,.20),0 22px 55px rgba(0,0,0,.68)}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.ghost{background:rgba(255,255,255,.04);box-shadow:none}
    .grid{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .card{width:100%;text-align:left;padding:14px;border-radius:18px;border:1px solid var(--b);background:linear-gradient(180deg,rgba(17,17,17,.92),rgba(10,10,10,.95));box-shadow:0 18px 36px rgba(0,0,0,.78);cursor:pointer;transition:transform .14s ease,box-shadow .18s ease,border-color .18s ease}
    .card:hover{transform:translateY(-2px);border-color:rgba(255,213,106,.42);box-shadow:0 24px 60px rgba(0,0,0,.78)}
    .k{font-size:16px;font-weight:950;display:flex;align-items:center;gap:10px}
    .k:before{content:'';width:10px;height:10px;border-radius:999px;background:rgba(255,213,106,.95);box-shadow:0 0 0 4px rgba(212,175,55,.12)}
    .s{margin-top:2px;color:var(--m);font-size:13px}
    .panel{border:1px solid rgba(212,175,55,.28);background:linear-gradient(180deg,rgba(17,17,17,.92),rgba(10,10,10,.95));border-radius:18px;padding:14px;box-shadow:0 18px 40px rgba(0,0,0,.75)}
    .exo{margin-top:12px;border-radius:16px;border:1px solid rgba(255,213,106,.22);background:linear-gradient(180deg,rgba(17,17,17,.95),rgba(12,12,12,.96));padding:14px;box-shadow:0 18px 40px rgba(0,0,0,.75)}
    .meta{margin:6px 0 0 0;font-size:12px;color:#c1c1c1}
    .goal{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,213,106,.24);background:rgba(212,175,55,.10);font-weight:950}
    label{display:block;margin-top:10px;font-size:13px}
    input{width:100%;padding:10px 11px;margin-top:6px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(5,5,5,.75);color:var(--t);outline:none}
    input:focus{border-color:rgba(255,213,106,.55);box-shadow:0 0 0 4px rgba(212,175,55,.10)}
    .seg{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .sbtn{appearance:none;border:1px solid rgba(212,175,55,.28);background:rgba(255,255,255,.03);color:var(--t);padding:8px 10px;border-radius:999px;font-weight:950;cursor:pointer;transition:transform .08s ease,border-color .18s ease,background .18s ease}
    .sbtn:hover{border-color:rgba(255,213,106,.55);background:rgba(212,175,55,.08)}
    .sbtn:active{transform:translateY(1px) scale(.99)}
    .sbtn.on{border-color:rgba(255,213,106,.75);background:rgba(212,175,55,.14);color:var(--g2)}
    .small{font-size:12px;color:var(--m)}
    .res{margin-top:10px;font-weight:950;font-size:13px;color:var(--g2);white-space:pre-line}
    .why{margin-top:8px;border:1px solid rgba(255,213,106,.18);border-radius:14px;background:rgba(255,255,255,.02);padding:10px 12px;font-size:12px;color:rgba(255,255,255,.9)}
    .why b{color:rgba(255,213,106,.92)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:9999;display:none;max-width:min(720px,92vw);border-radius:999px;border:1px solid rgba(255,213,106,.35);background:rgba(8,8,8,.82);backdrop-filter:blur(10px);padding:10px 14px;box-shadow:0 22px 60px rgba(0,0,0,.8);color:var(--t);font-weight:950}
    .toast.on{display:block}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);z-index:9998;padding:14px}
    .overlay.on{display:flex}
    .box{width:min(760px,100%);border-radius:22px;border:1px solid rgba(255,213,106,.28);background:linear-gradient(180deg,rgba(17,17,17,.96),rgba(8,8,8,.96));box-shadow:0 28px 80px rgba(0,0,0,.9);padding:18px}
    .boxH{display:flex;gap:12px;align-items:flex-start;justify-content:space-between}
    .boxI{width:44px;height:44px;border-radius:16px;display:grid;place-items:center;font-weight:950;color:var(--g2);border:1px solid rgba(212,175,55,.55);background:radial-gradient(circle at 30% 30%,rgba(255,213,106,.55),rgba(212,175,55,.12) 55%,rgba(212,175,55,.05))}
    .boxT{font-weight:950;font-size:18px;letter-spacing:.02em}
    .boxP{margin-top:10px;color:rgba(249,249,249,.9);font-size:14px;line-height:1.4}
    .boxA{margin-top:14px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,213,106,.16);text-align:left;font-size:13px;vertical-align:top}
    th{color:rgba(255,213,106,.9);font-weight:950}
    .bar{height:10px;border-radius:999px;border:1px solid rgba(255,213,106,.22);background:rgba(255,255,255,.03);overflow:hidden}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,rgba(255,213,106,.7),rgba(212,175,55,.55))}
    details{border:1px solid rgba(255,213,106,.16);border-radius:16px;padding:10px 12px;background:rgba(255,255,255,.02)}
    summary{cursor:pointer;font-weight:950}
    .muted{color:var(--m)}
    .focus{position:fixed;inset:0;z-index:9997;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.78);backdrop-filter:blur(10px);padding:14px}
    .focus.on{display:flex}
    .focusBox{width:min(760px,100%);border-radius:26px;border:1px solid rgba(255,213,106,.28);background:linear-gradient(180deg,rgba(17,17,17,.96),rgba(8,8,8,.96));box-shadow:0 28px 80px rgba(0,0,0,.9);padding:18px}
    .focusHead{display:flex;align-items:center;justify-content:space-between;gap:10px}

    /* Swap UI */
    .pick{display:grid;gap:10px;margin-top:12px}
    .pick .opt{width:100%;text-align:left;border-radius:16px;border:1px solid rgba(255,213,106,.18);background:rgba(255,255,255,.02);padding:12px 12px;cursor:pointer;font-weight:950}
    .pick .opt:hover{border-color:rgba(255,213,106,.55);background:rgba(212,175,55,.08)}
    .pick .opt small{display:block;margin-top:4px;font-weight:700;color:rgba(255,255,255,.72)}
    .exoNameRow{display:flex;align-items:center;gap:10px}
    .swapBadge{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(255,213,106,.35);
      background:rgba(212,175,55,.12);
      box-shadow:0 0 0 1px rgba(255,213,106,.10), 0 14px 30px rgba(0,0,0,.55);
      font-size:18px;
      cursor:pointer;
      user-select:none;
    }
    .swapHint{font-size:12px;color:rgba(255,213,106,.9);font-weight:950}
    .exoNameBtn{
      appearance:none;border:none;background:transparent;color:inherit;
      padding:0;margin:0;cursor:pointer;text-align:left;
      font:inherit
    }
    .exoNameBtn:hover{opacity:.95}

    /* Rest timer bar */
    .rt{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:10px;
      z-index:10001; /* ‚úÖ FIX: visible over Focus */
      width:min(920px, calc(100vw - 24px));
      border-radius:18px;
      border:1px solid rgba(255,213,106,.28);
      background:rgba(10,10,10,.78);
      backdrop-filter:blur(10px);
      box-shadow:0 22px 60px rgba(0,0,0,.82);
      display:none;
      padding:10px 10px;
      gap:10px;
      align-items:center;
    }
    .rt.on{display:flex}
    .rtL{min-width:140px;max-width:42%;display:flex;flex-direction:column;gap:2px}
    .rtT{font-weight:950;color:rgba(255,213,106,.95);line-height:1.1}
    .rtS{font-size:12px;color:rgba(255,255,255,.75);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rtC{
      font-weight:950;font-size:22px;letter-spacing:.02em;
      padding:6px 10px;border-radius:14px;
      border:1px solid rgba(255,213,106,.18);
      background:rgba(255,255,255,.03);
      min-width:92px;text-align:center;
    }
    .rtA{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-left:auto}
    .rtBtn{padding:9px 10px}
    @media (max-width:520px){
      .rt{gap:8px;padding:10px}
      .rtL{max-width:48%}
      .rtC{font-size:20px;min-width:86px}
      .rtA{gap:6px}
    }
 /* ‚úÖ Timer finished animation */
.rt.done{
  animation: rtPulse .65s ease-in-out 0s 3;
  border-color: rgba(255,213,106,.75);
  box-shadow: 0 0 0 2px rgba(255,213,106,.12), 0 22px 60px rgba(0,0,0,.82);
}
.rt.done .rtC{
  animation: rtBounce .55s ease-in-out 0s 2;
  border-color: rgba(255,213,106,.65);
  background: rgba(212,175,55,.14);
}

@keyframes rtPulse{
  0%{ transform:translateX(-50%) scale(1); }
  50%{ transform:translateX(-50%) scale(1.015); }
  100%{ transform:translateX(-50%) scale(1); }
}
@keyframes rtBounce{
  0%{ transform:scale(1); }
  35%{ transform:scale(1.05); }
  100%{ transform:scale(1); }
}
 
/* Emp√™che le zoom double-tap sur mobile (WebView / iOS) */
html, body { touch-action: manipulation; }

/* ‚úÖ Timer finished animation */
.rt.done{
  animation: rtPulse .65s ease-in-out 0s 3;
  border-color: rgba(255,213,106,.75);
  box-shadow: 0 0 0 2px rgba(255,213,106,.12), 0 22px 60px rgba(0,0,0,.82);
}
.rt.done .rtC{
  animation: rtBounce .55s ease-in-out 0s 2;
  border-color: rgba(255,213,106,.65);
  background: rgba(212,175,55,.14);
}
@keyframes rtPulse{
  0%{ transform:translateX(-50%) scale(1); }
  50%{ transform:translateX(-50%) scale(1.015); }
  100%{ transform:translateX(-50%) scale(1); }
}
@keyframes rtBounce{
  0%{ transform:scale(1); }
  35%{ transform:scale(1.05); }
  100%{ transform:scale(1); }
}

/* ‚úÖ Mobile: mode repos plein √©cran (lisible, ne masque pas la s√©ance par "moiti√©") */
@media (max-width:520px){
  body.rt_full .wrap{ opacity:.02; pointer-events:none; }
  body.rt_full .rt{
    left:0; bottom:0; transform:none;
    width:100vw; height:100vh;
    border-radius:0;
    padding:18px 16px calc(18px + env(safe-area-inset-bottom, 0px)) 16px;
    flex-direction:column;
    align-items:stretch;
    justify-content:center;
    gap:14px;
  }
  body.rt_full .rtL{ max-width:100%; min-width:0; }
  body.rt_full .rtT{ font-size:22px; }
  body.rt_full .rtS{ font-size:14px; white-space:normal; overflow:visible; text-overflow:clip; }
  body.rt_full .rtC{ font-size:56px; padding:14px 12px; min-width:0; }
  body.rt_full .rtA{
    margin-left:0;
    width:100%;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
  }
  body.rt_full .rtBtn{ padding:12px 14px; font-size:16px; }
}


/* ‚úÖ Micro animation (CTA fin de s√©ance) */
@keyframes ctaGlow{
  0%{ transform:translateY(0) scale(1); box-shadow:0 0 0 1px rgba(255,213,106,.10),0 18px 40px rgba(0,0,0,.55); }
  45%{ transform:translateY(-1px) scale(1.01); box-shadow:0 0 0 1px rgba(255,213,106,.25),0 24px 60px rgba(0,0,0,.70); }
  100%{ transform:translateY(0) scale(1); box-shadow:0 0 0 1px rgba(255,213,106,.10),0 18px 40px rgba(0,0,0,.55); }
}
.btn.ctaPulse{
  animation: ctaGlow .9s ease-in-out 0s 2;
  border-color: rgba(255,213,106,.70);
}


/* ‚úÖ FIX: √©viter le d√©calage horizontal du chrono en fin d‚Äôanimation */
.rt{
  transform-origin: center center;
}
body.rt_full .rt.done{
  transform: none !important;
}


/* ‚úÖ S√©ance en cours : mise en √©vidence */
.card.active-session{
  border-color: rgba(255,213,106,.75);
  box-shadow: 0 0 0 2px rgba(255,213,106,.18), 0 24px 60px rgba(0,0,0,.75);
}
.card.active-session .k:before{
  background: rgba(255,213,106,1);
}


/* ‚úÖ S√©ance en cours : surbrillance + badge lisible */
.card.active-session{
  border-color: rgba(255,213,106,.85) !important;
  background: linear-gradient(180deg, rgba(40,30,8,.35), rgba(10,10,10,.95));
  box-shadow: 0 0 0 2px rgba(255,213,106,.22), 0 26px 70px rgba(0,0,0,.82);
}
.asBadge{
  display:inline-flex;align-items:center;gap:6px;
  margin-top:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,213,106,.45);
  background:rgba(212,175,55,.14);
  color:rgba(255,213,106,.95);
  font-size:12px;
  font-weight:950;
  width:max-content;
}


    /* ‚úÖ FIX iOS: timer "done" pulse should NOT change transform (prevents lateral jump) */
    .rt.done{
      /* override previous rtPulse that animates transform */
      animation: rtPulseNM .65s ease-in-out 0s 3;
      will-change: box-shadow, border-color;
    }
    @keyframes rtPulseNM{
      0%{
        box-shadow: 0 0 0 2px rgba(255,213,106,.10), 0 22px 60px rgba(0,0,0,.82);
      }
      50%{
        box-shadow: 0 0 0 6px rgba(255,213,106,.14), 0 26px 70px rgba(0,0,0,.86);
      }
      100%{
        box-shadow: 0 0 0 2px rgba(255,213,106,.10), 0 22px 60px rgba(0,0,0,.82);
      }
    }

  
/* ‚úÖ Stats: R√©sum√© visuel (2 anneaux) */
.ringsWrap{margin-top:12px;border:1px solid rgba(255,213,106,.28);background:linear-gradient(180deg,rgba(17,17,17,.92),rgba(10,10,10,.95));border-radius:18px;padding:14px;box-shadow:0 18px 40px rgba(0,0,0,.75)}
.ringsTop{display:flex;flex-direction:column;gap:4px}
.ringsTitle{font-weight:950}
.ringsHint{font-size:12px;color:rgba(255,255,255,.72);line-height:1.25}
.ringsRow{display:flex;gap:12px;align-items:stretch;justify-content:space-between;flex-wrap:nowrap;margin-top:12px}
.ringCard{flex:1 1 0;min-width:0;display:flex;gap:12px;align-items:center;border:1px solid rgba(255,213,106,.16);border-radius:16px;padding:12px;background:rgba(255,255,255,.02)}
.ringSvg{width:66px;height:66px;flex:0 0 auto}
.ringLbl{min-width:0}
.ringName{font-weight:950;font-size:13px;letter-spacing:.02em}
.ringSub{font-size:12px;color:rgba(255,255,255,.75);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ringMsg{margin-top:7px;font-size:12px;color:rgba(255,213,106,.92);font-weight:950;line-height:1.25}
@media (max-width:520px){
  .ringsRow{flex-wrap:wrap}
  .ringCard{width:100%}
  .ringSub{white-space:normal}
}

/* ‚úÖ R√©sum√© visuel (compact, 2 anneaux sur une ligne) */
.rvMeta{
  color: rgba(255,255,255,.62);
  font-size: 13px;
  line-height: 1.25;
  margin: 6px 0 10px;
}
.rvGrid2{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  align-items: stretch;
}
.rvCard2{
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,213,106,.18);
  border-radius: 18px;
  padding: 12px 10px 10px;
  min-width: 0;
  text-align: center;
}
.rvRing{
  display:flex;
  justify-content:center;
  margin: 2px 0 6px;
}
.rvRing svg{ width: 84px; height: 84px; }
.rvLabel{
  font-weight: 800;
  font-size: 16px;
  margin-top: 2px;
}
.rvSmall{
  color: rgba(255,255,255,.62);
  font-size: 12px;
  margin-top: 2px;
}
.rvHint{
  color: rgba(255,213,106,.86);
  font-weight: 700;
  font-size: 12px;
  line-height: 1.25;
  margin-top: 8px;
  padding: 0 6px;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
@media (max-width: 360px){
  .rvGrid2{ gap: 10px; }
  .rvRing svg{ width: 78px; height: 78px; }
  .rvLabel{ font-size: 15px; }
}


/* ============================
   Aura Farm V3 ‚Äî DA Apple-like
   (keeps V2 logic/JS)
   ============================ */
:root{
  --v3-bg:#0b0b0c;
  --v3-card:rgba(255,255,255,.04);
  --v3-card2:rgba(255,255,255,.02);
  --v3-stroke:rgba(255,255,255,.10);
  --v3-stroke2:rgba(255,255,255,.08);
  --v3-text:#f5f5f7;
  --v3-muted:rgba(245,245,247,.70);
  --v3-muted2:rgba(245,245,247,.56);
  --v3-gold:#d4af37;
  --v3-goldSoft:rgba(212,175,55,.18);
  --v3-accent:#0a84ff;
}

body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 20% -10%,rgba(212,175,55,.15),transparent 60%),
    radial-gradient(800px 500px at 90% 10%,rgba(10,132,255,.15),transparent 55%),
    var(--v3-bg) !important;
  color:var(--v3-text) !important;
  letter-spacing:0 !important;
  padding:0 !important;
}

/* hide legacy bits we don't use in V3 header */
#modePill{ display:none !important; }

/* header */
.v3Top{
  position:sticky;
  top:0;
  z-index:10;
  border:none !important;
  background:linear-gradient(180deg,rgba(11,11,12,.94),rgba(11,11,12,.72)) !important;
  backdrop-filter: blur(14px);
  box-shadow:none !important;
  border-radius:0 !important;
  padding:18px 18px 12px !important;
  margin:0 0 10px 0 !important;
}

.v3Header{ display:flex; flex-direction:column; gap:12px; }
.v3Brand{ display:flex; align-items:center; gap:14px; }
.v3Logo{
  width:44px; height:44px; border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(135deg,#f7d774,#b8962e);
  color:#000; font-weight:900;
  box-shadow:0 14px 40px rgba(0,0,0,.45);
}
.v3Title{
  font-size:28px;
  font-weight:900;
  margin:0;
}
.v3Sub{
  margin-top:2px;
  color:var(--v3-muted);
  font-size:13px;
}

/* nav tabs */
.v3Nav{ display:flex; gap:10px; }
.v3Tab{
  flex:1;
  appearance:none;
  border-radius:14px;
  padding:12px 10px;
  border:1px solid var(--v3-goldSoft);
  background:rgba(255,255,255,.02);
  color:var(--v3-text);
  font-weight:800;
  cursor:pointer;
}
.v3Tab.on{
  background:linear-gradient(180deg,rgba(212,175,55,.35),rgba(212,175,55,.05));
  border-color:rgba(212,175,55,.60);
}

/* main container */
.wrap{ max-width:940px !important; padding:0 16px 28px; margin:0 auto; }

/* panels/cards */
.panel, .exo, .card{
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)) !important;
  border:1px solid rgba(255,255,255,.08) !important;
  border-radius:22px !important;
  box-shadow:none !important;
}
.panel{ padding:18px !important; }

/* home session list: make cards look like the concept rows */
.grid{ gap:0 !important; }
.card{
  margin:0 !important;
  border-radius:22px !important;
  padding:18px !important;
}
#homeCards .card{
  text-align:left;
}
#homeCards .card + .card{
  margin-top:12px !important;
}
#homeCards .k{
  gap:0 !important;
}
.k{
  font-size:18px !important;
  font-weight:900 !important;
}
.k:before{ display:none !important; }
.session-letter{
  color:var(--v3-gold);
  font-weight:950;
  letter-spacing:0.02em;
  text-shadow:0 2px 10px rgba(212,175,55,.24);
}
.session-title-word{
  color:var(--v3-gold);
  margin-right:6px;
}
.s{
  color:var(--v3-muted) !important;
  font-size:14px !important;
  margin-top:6px !important;
}
#homeCards .card::after{
  content:'‚Ä∫';
  float:right;
  color:var(--v3-muted);
  font-size:22px;
  margin-top:-34px;
}

/* session header buttons */
#vSession .btn, #vGoals .btn, #vStats .btn{
  border-radius:14px !important;
}
h1{ letter-spacing:0 !important; }

/* text */
.small{ color:var(--v3-muted) !important; }
.meta{ color:var(--v3-muted) !important; }
.goal{
  border:1px solid rgba(212,175,55,.20) !important;
  background:rgba(212,175,55,.10) !important;
}

/* inputs */
input{
  border-radius:14px !important;
  border:1px solid rgba(255,255,255,.14) !important;
  background:rgba(255,255,255,.03) !important;
}
input:focus{
  border-color:rgba(10,132,255,.55) !important;
  box-shadow:0 0 0 4px rgba(10,132,255,.18) !important;
}

/* toast + overlays slightly softer */
.toast{
  border:1px solid rgba(255,255,255,.14) !important;
  background:rgba(18,18,18,.78) !important;
}
.box, .focusBox{
  border:1px solid rgba(255,255,255,.10) !important;
  background:linear-gradient(180deg,rgba(20,20,22,.92),rgba(10,10,12,.92)) !important;
}

/* make sure tabs highlight follows active view */


/* ============================
   Aura Farm V3 ‚Äî Investor Polish
   (DA only, keeps JS logic)
   ============================ */

/* Global smoothing */
body{
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Premium background grain + vignette */
body::before{
  content:'';
  position:fixed; inset:-40px;
  pointer-events:none;
  background:
    radial-gradient(1200px 700px at 15% -10%, rgba(212,175,55,.18), transparent 62%),
    radial-gradient(1000px 650px at 95% 5%, rgba(10,132,255,.16), transparent 58%),
    radial-gradient(900px 650px at 55% 120%, rgba(50,215,75,.10), transparent 58%),
    radial-gradient(1200px 900px at 50% 50%, rgba(0,0,0,.55), transparent 60%),
    repeating-linear-gradient(0deg, rgba(255,255,255,.018) 0, rgba(255,255,255,.018) 1px, transparent 1px, transparent 3px);
  opacity:.9;
  filter:saturate(1.05);
  z-index:-1;
}
body::after{
  content:'';
  position:fixed; inset:0;
  pointer-events:none;
  background:radial-gradient(900px 700px at 50% 10%, transparent 40%, rgba(0,0,0,.55) 100%);
  opacity:.55;
  z-index:-1;
}

/* Constrain content width with nicer breathing */
.wrap{ padding:0 18px 34px !important; }

/* Header: hero feel */
.v3Top{
  padding:22px 18px 14px !important;
}
.v3Brand{
  gap:16px !important;
}
.v3Logo{
  width:48px !important; height:48px !important;
  border-radius:16px !important;
  box-shadow:
    0 1px 0 rgba(255,255,255,.35) inset,
    0 24px 70px rgba(0,0,0,.55) !important;
  transform:translateZ(0);
}
.v3Title{
  font-size:30px !important;
  letter-spacing:-0.02em !important;
  line-height:1.05 !important;
}
.v3Sub{
  font-size:13px !important;
  letter-spacing:0 !important;
}

/* Tabs: Apple segmented-control vibe */
.v3Nav{
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.10);
  border-radius:16px;
  padding:6px;
  gap:6px !important;
  box-shadow:0 18px 50px rgba(0,0,0,.35);
}
.v3Tab{
  border:none !important;
  background:transparent !important;
  border-radius:12px !important;
  padding:12px 10px !important;
  font-weight:900 !important;
  color:rgba(245,245,247,.78) !important;
  transition:transform .12s ease, background .18s ease, color .18s ease, box-shadow .18s ease;
}
.v3Tab.on{
  color:#0b0b0c !important;
  background:linear-gradient(135deg, rgba(255,213,106,.95), rgba(212,175,55,.88)) !important;
  box-shadow:
    0 1px 0 rgba(255,255,255,.55) inset,
    0 18px 40px rgba(0,0,0,.35);
}
.v3Tab:active{ transform:scale(.985); }

/* Panels & cards: premium glass */
.panel, .exo, .card{
  position:relative;
  overflow:hidden;
}
.panel::before, .exo::before, .card::before{
  content:'';
  position:absolute; inset:0;
  pointer-events:none;
  background:
    radial-gradient(900px 360px at 15% 0%, rgba(255,255,255,.06), transparent 55%),
    radial-gradient(700px 320px at 85% 10%, rgba(255,213,106,.06), transparent 60%);
  opacity:.75;
}
.panel{
  padding:20px !important;
  border-radius:24px !important;
  box-shadow:
    0 1px 0 rgba(255,255,255,.08) inset,
    0 22px 70px rgba(0,0,0,.55) !important;
}
.card{
  border-radius:24px !important;
  box-shadow:
    0 1px 0 rgba(255,255,255,.08) inset,
    0 22px 70px rgba(0,0,0,.52) !important;
  transition:transform .16s ease, box-shadow .18s ease, border-color .18s ease;
}
.card:hover{
  transform:translateY(-3px) !important;
  box-shadow:
    0 1px 0 rgba(255,255,255,.10) inset,
    0 28px 90px rgba(0,0,0,.62) !important;
}
#homeCards .card::after{
  content:'‚Ä∫';
  color:rgba(245,245,247,.60);
  font-size:26px;
  margin-top:-40px;
}

/* Card typography */
.k{
  letter-spacing:-0.01em !important;
}
.s{
  font-size:14px !important;
}

/* Buttons: soft depth */
.btn{
  border:1px solid rgba(255,255,255,.14) !important;
  background:rgba(255,255,255,.06) !important;
  box-shadow:
    0 1px 0 rgba(255,255,255,.08) inset,
    0 18px 55px rgba(0,0,0,.45) !important;
  transition:transform .12s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
}
.btn:hover{
  background:rgba(255,255,255,.08) !important;
}
.btn:active{
  transform:translateY(1px) scale(.99) !important;
  box-shadow:
    0 1px 0 rgba(255,255,255,.06) inset,
    0 14px 40px rgba(0,0,0,.45) !important;
}
.btn.ghost{
  background:rgba(255,255,255,.03) !important;
  box-shadow:none !important;
}

/* Inputs: iOS field look */
input{
  padding:12px 12px !important;
  border-radius:16px !important;
}
label{
  letter-spacing:-0.01em;
}

/* Exercise cards: clearer hierarchy */
.exo{
  border-radius:24px !important;
  padding:18px !important;
  box-shadow:
    0 1px 0 rgba(255,255,255,.08) inset,
    0 22px 70px rgba(0,0,0,.55) !important;
}
.exo .meta{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.exo .meta .btn{
  box-shadow:none !important;
}
.goal{
  border-radius:18px !important;
  padding:12px 14px !important;
  box-shadow:0 1px 0 rgba(255,255,255,.06) inset;
}

/* Toast: iOS banner */
.toast{
  border-radius:999px !important;
  padding:12px 16px !important;
  background:rgba(18,18,20,.74) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  box-shadow:0 26px 90px rgba(0,0,0,.70) !important;
}

/* Overlays: cinematic */
.overlay.on, .focus.on{
  background:rgba(0,0,0,.64) !important;
}
.box, .focusBox{
  border-radius:28px !important;
  box-shadow:0 28px 120px rgba(0,0,0,.85) !important;
}

/* Rest timer: premium bottom sheet */
.rt{
  border-radius:26px !important;
  padding:12px 12px !important;
  background:rgba(18,18,20,.82) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  box-shadow:
    0 1px 0 rgba(255,255,255,.08) inset,
    0 28px 110px rgba(0,0,0,.80) !important;
}
.rtL{ min-width:150px !important; }
.rtT{ letter-spacing:-0.01em !important; }
.rtC{
  border-radius:18px !important;
  min-width:98px !important;
  box-shadow:0 1px 0 rgba(255,255,255,.06) inset;
}

/* Micro animation: subtle shimmer on active tab */
.v3Tab.on{
  position:relative;
  overflow:hidden;
}
.v3Tab.on::after{
  content:'';
  position:absolute; inset:-30% -60%;
  background:linear-gradient(120deg, transparent 35%, rgba(255,255,255,.35) 50%, transparent 65%);
  transform:translateX(-30%);
  animation:v3Shimmer 2.2s ease-in-out infinite;
  opacity:.35;
}
@keyframes v3Shimmer{
  0%{ transform:translateX(-40%); }
  55%{ transform:translateX(55%); }
  100%{ transform:translateX(55%); }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .v3Tab.on::after{ animation:none !important; }
  .card:hover{ transform:none !important; }
}

/* Mobile tweaks */
@media (max-width:420px){
  .v3Title{ font-size:26px !important; }
  .v3Logo{ width:44px !important;height:44px !important; }
  .wrap{ padding:0 14px 30px !important; }
  .panel, .card, .exo{ border-radius:22px !important; }
}

</style>
</head>
<body>
<div class="wrap">
  <header class="top v3Top">
  <div class="v3Header">
    <div class="v3Brand">
      <div class="v3Logo">P</div>
      <div>
        <div class="v3Title">Aura Farm</div>
        <div class="v3Sub">S‚Äôentra√Æner avec m√©thode. Progresser avec certitude.</div>
      </div>
    </div>

    <div class="v3Nav" role="navigation" aria-label="Navigation">
      <button class="v3Tab on" type="button" id="sessionsBtn">S√©ances</button>
      <button class="v3Tab" type="button" id="goalsBtn">Objectifs</button>
      <button class="v3Tab" type="button" id="statsBtn">Stats</button>
    </div>
  </div>
</header>

  <div id="modePill" style="display:none"></div>
  <section id="vHome">
    <div class="panel" style="margin-bottom:14px">
      <div style="font-weight:950;font-size:16px">Semaine en cours</div>
      <div class="small" style="margin-top:6px">Pendant la s√©ance : tu ne saisis que <b>reps</b> + <b>effort</b> (et la charge). L‚Äôappli te dit quoi faire et pourquoi.</div>
    </div>
    <div class="grid" id="homeCards"></div>
  </section>

  <section id="vSession" style="display:none">
    <div class="row" style="margin-top:2px">
      <div class="small" style="margin-bottom:6px;color:rgba(255,213,106,.95)">üü° <b>S√©ance en cours</b> ‚Äî Les exercices valid√©s sont conserv√©s. Appuie sur <b>Terminer</b> pour enregistrer la s√©ance dans l‚Äôhistorique.</div>
      <div>
        <h1 id="sessTitle" style="font-size:18px;font-weight:950;margin:0"><span class="session-title-word">S√©ance</span></h1>
        <div class="small" id="sessMeta" style="margin-top:4px">‚Äî</div>
      </div>
      <div class="row">
        <button class="btn ghost" type="button" onclick="goHome()">Menu</button>
        <button class="btn ghost" type="button" id="focusBtn">üéØüß≠ Focus s√©ance</button>
        <button class="btn" type="button" id="btnDone">Terminer ‚Ä¢ Enregistrer dans l‚Äôhistorique</button>
      </div>
    </div>
    <div id="exoList"></div>
    <div style="margin:20px 0;text-align:center">
      <div class="small" style="margin-bottom:8px;color:rgba(255,213,106,.95)">
        Fin de s√©ance ‚Äî enregistre pour l‚Äôhistorique
      </div>
      <button class="btn" type="button" id="btnDoneBottom"
        onclick="document.getElementById('btnDone').click()">
        Terminer ‚Ä¢ Enregistrer dans l‚Äôhistorique
      </button>
    </div>

  </section>

  <section id="vGoals" style="display:none">
    <div class="row" style="margin-top:2px">
      <div id="hintGoals" class="small" style="display:none;margin-bottom:6px;color:rgba(255,213,106,.95)"></div>
      <div>
        <h1 style="font-size:18px;font-weight:950;margin:0">Objectifs</h1>
        <div class="small" style="margin-top:4px">Renseigne tes <b>RP10</b> (charge que tu peux faire sur 10 reps √† l‚Äô√©chec). Base coh√©rente si un exercice n‚Äôa pas encore d‚Äôhistorique.</div>
      </div>
      <div class="row">
        <button class="btn ghost" type="button" onclick="goHome()">Retour</button>
        <button class="btn ghost" type="button" onclick="exportData()">Exporter</button>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div style="font-weight:950">Table RP10</div>
      <div class="small muted" style="margin-top:6px">Si un exercice n‚Äôa <b>aucun log</b>, la charge cible (dans la s√©ance) est estim√©e depuis le RP10 + la cible de reps.</div>

      <label style="margin-top:12px">Rechercher un exercice (nom / type)
        <input id="rp10Search" type="text" placeholder="ex : rowing, presse, triceps, poulie‚Ä¶" oninput="setGoalsQuery(this.value)"/>
      </label>
      <div class="small muted" id="rp10Count" style="margin-top:6px">‚Äî</div>

      <div id="rp10Table"></div>
    </div>
  </section>

  <section id="vStats" style="display:none">
    <div class="row" style="margin-top:2px">
      <div id="hintStats" class="small" style="display:none;margin-bottom:6px;color:rgba(255,213,106,.95)"></div>
      <h1 style="font-size:18px;font-weight:950;margin:0">Stats</h1>
      <div class="row">
        <button class="btn ghost" type="button" onclick="goHome()">Retour</button>
        <button class="btn ghost" type="button" onclick="triggerImport()">Importer</button>
        <button class="btn ghost" type="button" onclick="exportData()">Exporter</button>
      </div>
    </div>
    <input id="importCsv" type="file" accept=".csv,text/csv" style="display:none"/>

    <div class="panel" style="margin-top:12px">
      <div style="font-weight:950">S√©ries semaine</div>
      <div class="small" id="weekRange" style="margin-top:6px">‚Äî</div>
      <div id="weekVol"></div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div style="font-weight:950">R√©sum√© visuel</div>
      <div id="trend"></div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div style="font-weight:950">Historique</div>
      <div class="small" style="margin-top:6px">Tu peux modifier reps/charge si tu t‚Äôes tromp√©.</div>
      <div id="hist"></div>
      <div class="small" style="margin-top:10px;color:rgba(255,213,106,.9)">‚ö†Ô∏è Conseil : exporte 1√ó/semaine pour te faire une sauvegarde CSV.</div>
      <div class="small" style="margin-top:6px;color:rgba(255,255,255,.72)">Astuce : importe un export CSV Aura Farm pour restaurer l‚Äôhistorique apr√®s une mise √† jour.</div>
    </div>
  </section>
</div>

<!-- Focus mode -->
<div class="focus" id="focus">
  <div class="focusBox">
    <div class="focusHead">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="boxI">üéØ</div>
        <div>
          <div class="boxT" id="fTitle">üéØüß≠ Focus s√©ance</div>
          <div class="small" id="fSub">‚Äî</div>
        </div>
      </div>
      <button class="btn" type="button" onclick="toggleFocus(false)">Quitter le focus</button>
    </div>
    <div id="fBody" style="margin-top:12px"></div>
  </div>
</div>

<!-- Swap overlay -->
<div class="overlay" id="swap">
  <div class="box">
    <div class="boxH">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="boxI">‚áÑ</div>
        <div>
          <div class="boxT" id="swapT">Choisir une variante</div>
          <div class="small" id="swapS">‚Äî</div>
        </div>
      </div>
      <button class="btn ghost" type="button" onclick="closeSwap()">Fermer</button>
    </div>
    <div class="boxP" id="swapB" style="margin-top:10px">M√™me logique, m√™me groupe musculaire. Historique conserv√© par exercice choisi.</div>
    <div class="pick" id="swapList"></div>
    <div class="boxA">
      <button class="btn" type="button" onclick="closeSwap()">OK</button>
    </div>
  </div>
</div>


<!-- Leave session confirm -->
<div class="overlay" id="leaveSess">
  <div class="box">
    <div class="boxH">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="boxI">‚ö†Ô∏è</div>
        <div>
          <div class="boxT" id="leaveT">Quitter la s√©ance ?</div>
          <div class="small" id="leaveS">‚Äî</div>
        </div>
      </div>
      <button class="btn ghost" type="button" onclick="closeLeaveSess()">Fermer</button>
    </div>
    <div class="boxP" id="leaveB" style="margin-top:10px">
      ‚Äî
    </div>
    <div class="boxA">
      <button class="btn ghost" type="button" onclick="closeLeaveSess()">Rester</button>
      <button class="btn" type="button" id="leaveGo" onclick="confirmLeaveSessGo()">Quitter</button>
    </div>
  </div>
</div>


<div class="overlay" id="onb">
  <div class="box">
    <div class="boxH">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="boxI">P</div>
        <div>
          <div class="boxT" id="onbT">Aura Farm.</div>
          <div class="small" id="onbS">1/3</div>
        </div>
      </div>
      <button class="btn ghost" type="button" onclick="skipOnb()">Passer</button>
    </div>
    <div class="boxP" id="onbB">Tu t‚Äôentra√Ænes. On g√®re la progression.</div>
    <div class="boxA">
      <button class="btn" type="button" id="onbN" onclick="nextOnb()">Continuer</button>
    </div>
  </div>
</div>

<div class="overlay" id="done">
  <div class="box" style="text-align:center;padding:22px">
    <div style="font-weight:950;font-size:20px;background:linear-gradient(90deg,var(--g2),var(--g));-webkit-background-clip:text;background-clip:text;color:transparent;letter-spacing:.02em">S√©ance enregistr√©e dans l‚Äôhistorique.</div>
    <div class="boxP" style="margin-top:8px">Tu peux retrouver cette s√©ance dans <b>Stats</b>.</div>
    <div class="boxA" style="justify-content:center">
      <button class="btn" type="button" onclick="closeDone()">Retour</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Rest timer (sticky) -->
<div class="rt" id="rt" aria-live="polite">
  <div class="rtL">
    <div class="rtT" id="rtTitle">Repos</div>
    <div class="rtS" id="rtSub">‚Äî</div>
  </div>
  <div class="rtC" id="rtClock">00:00</div>
  <div class="rtA">
    <button class="btn ghost rtBtn" type="button" onclick="rtAdd(-15)">-15s</button>
    <button class="btn rtBtn" type="button" id="rtToggle" onclick="rtToggle()">Start</button>
    <button class="btn ghost rtBtn" type="button" onclick="rtAdd(15)">+15s</button>
    <button class="btn ghost rtBtn" type="button" onclick="rtReset()">Reset</button>
    <button class="btn ghost rtBtn" type="button" id="rtSoundBtn" onclick="rtToggleSound()">üîä</button>
<button class="btn ghost rtBtn" type="button" onclick="rtClose()">‚úï</button> <!-- ‚úÖ close -->
  </div>
</div>

<script>
'use strict';

// ============================
// Programme
// ============================
const M={CHEST:'Pecs',BACK:'Dos',BICEPS:'Biceps',TRICEPS:'Triceps',SHO:'√âpaules',QUADS:'Quadriceps',HAMS:'Ischios',CALVES:'Mollets'};

// Variantes : m√™me logique, m√™mes muscles / pattern.
const CATALOG={
  decline:[
    {vid:'decline_machine',name:'D√©velopp√© d√©clin√© machine',unit:'kg',step:2,pct:2.5},
    {vid:'decline_smith',name:'D√©velopp√© d√©clin√© Smith',unit:'kg',pct:2.5},
    {vid:'decline_db',name:'D√©velopp√© d√©clin√© halt√®res',unit:'kg par halt√®re',step:2},
    {vid:'decline_bb',name:'D√©velopp√© d√©clin√© barre',unit:'kg',pct:2.5},
    {vid:'decline_plate',name:'D√©velopp√© d√©clin√© convergent (plate-loaded)',unit:'kg',pct:2.5},
    {vid:'cable_press_low',name:'Chest press poulie (angle bas)',unit:'kg',step:2},
  ],
  incline:[
    {vid:'incline_db',name:'D√©velopp√© inclin√© halt√®res',unit:'kg par halt√®re',step:2},
    {vid:'incline_machine',name:'D√©velopp√© inclin√© machine',unit:'kg',step:2},
    {vid:'incline_smith',name:'D√©velopp√© inclin√© Smith',unit:'kg',pct:2.5},
    {vid:'incline_bb',name:'D√©velopp√© inclin√© barre',unit:'kg',pct:2.5},
    {vid:'incline_plate',name:'D√©velopp√© inclin√© convergent (plate-loaded)',unit:'kg',pct:2.5},
    {vid:'cable_press_mid',name:'Chest press poulie (angle moyen)',unit:'kg',step:2},
  ],

  chest_fly:[
    {vid:'pecdeck',name:'Pec Deck',unit:'kg',step:2},
    {vid:'butterfly',name:'Butterfly / √âcart√© machine',unit:'kg',step:2},
    {vid:'cable_fly',name:'√âcart√© poulie vis-√†-vis',unit:'kg',step:1},
    {vid:'db_fly',name:'√âcart√© halt√®res',unit:'kg par halt√®re',step:1},
    {vid:'low_to_high_fly',name:'√âcart√© poulie bas‚Üíhaut',unit:'kg',step:1},
  ],
  lat_raise:[
    {vid:'lat_db',name:'√âl√©vations lat√©rales',unit:'kg par halt√®re',step:1},
    {vid:'lat_machine',name:'√âl√©vations lat√©rales machine',unit:'kg',step:1},
    {vid:'lat_cable',name:'√âl√©vations lat√©rales poulie',unit:'kg',step:1},
    {vid:'lat_lean',name:'√âl√©vations lat√©rales (pench√©)',unit:'kg par halt√®re',step:1},
    {vid:'lat_uni_cable',name:'√âl√©vations lat√©rales poulie unilat.',unit:'kg',step:1},
  ],
  rear_delts:[
    {vid:'rev_pecdeck',name:'Pec Deck invers√©',unit:'kg',step:2},
    {vid:'rear_cable',name:'Oiseau poulie',unit:'kg',step:1},
    {vid:'rear_db',name:'Oiseau halt√®res (buste pench√©)',unit:'kg par halt√®re',step:1},
    {vid:'rear_machine',name:'Rear delt machine',unit:'kg',step:2},
    {vid:'facepull',name:'Face pull (arri√®re d‚Äô√©paule)',unit:'kg',step:2},
  ],
  tri_push:[
    {vid:'pushdown',name:'Extension triceps poulie',unit:'kg',step:1},
    {vid:'pushdown_rope',name:'Extension triceps corde',unit:'kg',step:1},
    {vid:'oh_ext',name:'Extension triceps nuque',unit:'kg',step:2},
    {vid:'oh_ext_cable',name:'Extension triceps nuque poulie',unit:'kg',step:1},
    {vid:'skull',name:'Barre au front (EZ)',unit:'kg',pct:2.5},
  ],
  pullup:[
    {vid:'pullup_neutral_w',name:'Tractions lest√©es (prise neutre)',unit:'lest (kg)',pct:2.5},
    {vid:'pullup_pron_w',name:'Tractions lest√©es (pronation)',unit:'lest (kg)',pct:2.5},
    {vid:'chinup_w',name:'Tractions supination lest√©es',unit:'lest (kg)',pct:2.5},
    {vid:'lat_neutral',name:'Tirage vertical neutre',unit:'kg',pct:2.5},
    {vid:'lat_pron',name:'Tirage vertical pronation',unit:'kg',pct:2.5},
    {vid:'pullup_assist',name:'Tractions assist√©es (neutre)',unit:'kg (assistance)',step:2},
  ],
  row_bar:[
    {vid:'row_bar',name:'Rowing barre',unit:'kg',pct:2.5},
    {vid:'row_chest_supported',name:'Rowing poitrine appuy√©e',unit:'kg',pct:2.5},
    {vid:'row_machine',name:'Rowing machine',unit:'kg',pct:2.5},
    {vid:'tbar_row',name:'Rowing T-bar',unit:'kg',pct:2.5},
    {vid:'seal_row',name:'Seal row (banc)',unit:'kg',pct:2.5},
    {vid:'row_landmine',name:'Rowing landmine',unit:'kg',pct:2.5},
  ],
  row_cable:[
    {vid:'row_tight',name:'Tirage horizontal serr√©',unit:'kg',pct:2.5},
    {vid:'row_neutral',name:'Tirage horizontal neutre',unit:'kg',pct:2.5},
    {vid:'row_wide',name:'Tirage horizontal large',unit:'kg',pct:2.5},
    {vid:'row_sup',name:'Tirage horizontal supination',unit:'kg',pct:2.5},
    {vid:'row_chest_cable',name:'Rowing poulie poitrine appuy√©e',unit:'kg',pct:2.5},
  ],
  curl_bi:[
    {vid:'hammer_incline',name:'Curl marteau inclin√©',unit:'kg par halt√®re',step:1},
    {vid:'preacher',name:'Curl pupitre (biceps court)',unit:'kg',step:1},
    {vid:'cable_curl',name:'Curl poulie (biceps court)',unit:'kg',step:1},
    {vid:'ez_curl',name:'Curl barre EZ',unit:'kg',pct:2.5},
    {vid:'spider_curl',name:'Spider curl',unit:'kg',step:1},
    {vid:'incline_db_curl',name:'Curl inclin√© halt√®res',unit:'kg par halt√®re',step:1},
  ],
  dips_machine:[
    {vid:'dips_machine',name:'Dips machine',unit:'kg',pct:2.5},
    {vid:'dip_assist',name:'Dips assist√©s',unit:'kg (assistance)',step:2},
    {vid:'dip_weighted',name:'Dips lest√©s',unit:'lest (kg)',pct:2.5},
    {vid:'close_grip_press',name:'D√©velopp√© serr√© (barre)',unit:'kg',pct:2.5},
    {vid:'close_grip_smith',name:'D√©velopp√© serr√© Smith',unit:'kg',pct:2.5},
  ],
  row_uni:[
    {vid:'row_uni',name:'Row unilat√©ral',unit:'kg',pct:2.5},
    {vid:'row_uni_cable',name:'Row unilat√©ral poulie',unit:'kg',pct:2.5},
    {vid:'db_row',name:'Row halt√®re unilat√©ral',unit:'kg',pct:2.5},
    {vid:'meadows_row',name:'Meadows row',unit:'kg',pct:2.5},
    {vid:'row_uni_machine',name:'Row unilat√©ral machine',unit:'kg',pct:2.5},
  ],

  // LEGS
  leg_press:[
    {vid:'leg_press',name:'Presse √† cuisses',unit:'kg',pct:2.5},
    {vid:'hack_squat',name:'Hack squat',unit:'kg',pct:2.5},
    {vid:'belt_squat',name:'Belt squat',unit:'kg',pct:2.5},
    {vid:'smith_squat',name:'Squat Smith (quad-dominant)',unit:'kg',pct:2.5},
    {vid:'pendulum',name:'Pendulum squat',unit:'kg',pct:2.5},
    {vid:'v_squat',name:'V-squat / machine squat',unit:'kg',pct:2.5},
  ],
  hip_hinge:[
    {vid:'rdl_bar',name:'Soulev√© de terre roumain (barre)',unit:'kg',pct:2.5},
    {vid:'rdl_db',name:'Soulev√© de terre roumain (halt√®res)',unit:'kg par halt√®re',step:2},
    {vid:'good_morning',name:'Good morning (barre)',unit:'kg',pct:2.5},
    {vid:'back_ext',name:'Extensions lombaires lest√©es',unit:'kg',step:2},
    {vid:'hip_hinge_machine',name:'Hip hinge machine',unit:'kg',pct:2.5},
  ],
  leg_curl:[
    {vid:'leg_curl_lying',name:'Leg curl couch√©',unit:'kg',step:2},
    {vid:'leg_curl_seated',name:'Leg curl assis',unit:'kg',step:2},
    {vid:'leg_curl_uni',name:'Leg curl unilat√©ral',unit:'kg',step:2},
  ],
  leg_ext:[
    {vid:'leg_ext',name:'Leg extension',unit:'kg',step:2},
    {vid:'sissy_machine',name:'Sissy squat machine',unit:'kg',step:2},
    {vid:'leg_ext_uni',name:'Leg extension unilat√©ral',unit:'kg',step:2},
  ],
  calves:[
    {vid:'calf_press',name:'Mollets √† la presse',unit:'kg',step:5},
    {vid:'calf_standing',name:'Mollets debout machine',unit:'kg',step:2},
    {vid:'calf_seated',name:'Mollets assis',unit:'kg',step:2},
    {vid:'donkey_calf',name:'Donkey calf raise',unit:'kg',step:2},
    {vid:'smith_calf',name:'Mollets debout Smith',unit:'kg',step:2},
  ],
};

const PROGRAM={
  A:{title:'S√©ance A',sub:'Pecs ¬∑ Triceps ¬∑ √âpaules',slots:[
    {sid:'A1',slot:'decline',muscle:M.CHEST,sets:4,lo:6,hi:10,rest:'2‚Äì3 min',baseLoad:60,defaultVid:'decline_machine'},
    {sid:'A2',slot:'incline',muscle:M.CHEST,sets:3,lo:8,hi:12,rest:'2 min',baseLoad:22,defaultVid:'incline_db'},
    {sid:'A2b',slot:'chest_fly',muscle:M.CHEST,sets:3,lo:10,hi:15,rest:'1‚Äì1.5 min',baseLoad:40,defaultVid:'pecdeck'},
    {sid:'A4',slot:'rear_delts',muscle:M.SHO,sets:3,lo:12,hi:20,rest:'1‚Äì1.5 min',baseLoad:35,defaultVid:'rev_pecdeck'},
    {sid:'A3',slot:'lat_raise',muscle:M.SHO,sets:3,lo:12,hi:20,rest:'1 min',baseLoad:6,defaultVid:'lat_db'},
    {sid:'A5',slot:'tri_push',muscle:M.TRICEPS,sets:3,lo:10,hi:15,rest:'1‚Äì1.5 min',baseLoad:25,defaultVid:'pushdown'},
  ]},
  B:{title:'S√©ance B',sub:'Dos ¬∑ Biceps',slots:[
    {sid:'B1',slot:'pullup',muscle:M.BACK,sets:4,lo:6,hi:8,rest:'2‚Äì3 min',baseLoad:5,defaultVid:'pullup_neutral_w'},
    {sid:'B2',slot:'row_bar',muscle:M.BACK,sets:4,lo:8,hi:12,rest:'2 min',baseLoad:60,defaultVid:'row_bar'},
    {sid:'B3',slot:'row_cable',muscle:M.BACK,sets:3,lo:10,hi:15,rest:'2 min',baseLoad:55,defaultVid:'row_tight'},
    {sid:'B4',slot:'curl_bi',muscle:M.BICEPS,sets:3,lo:8,hi:12,rest:'1 min',baseLoad:12,defaultVid:'hammer_incline'},
    {sid:'B5',slot:'curl_bi',muscle:M.BICEPS,sets:2,lo:12,hi:15,rest:'1 min',baseLoad:25,defaultVid:'preacher'},
  ]},
  C:{title:'S√©ance C',sub:'Haut ¬∑ Biceps ¬∑ Triceps',slots:[
    {sid:'C1',slot:'decline',muscle:M.CHEST,sets:2,lo:8,hi:12,rest:'2 min',baseLoad:50,defaultVid:'decline_machine',note:'Rappel technique. Pas d‚Äôobligation de progresser.'},
    {sid:'C2',slot:'dips_machine',muscle:M.CHEST,sets:2,lo:8,hi:15,rest:'2 min',baseLoad:80,defaultVid:'dips_machine'},
    {sid:'C3',slot:'pullup',muscle:M.BACK,sets:3,lo:10,hi:15,rest:'2 min',baseLoad:45,defaultVid:'lat_neutral'},
    {sid:'C4',slot:'row_uni',muscle:M.BACK,sets:3,lo:10,hi:15,rest:'2 min',baseLoad:28,defaultVid:'row_uni'},
    {sid:'C5',slot:'lat_raise',muscle:M.SHO,sets:3,lo:12,hi:20,rest:'1 min',baseLoad:6,defaultVid:'lat_db'},
    {sid:'C6',slot:'curl_bi',muscle:M.BICEPS,sets:3,lo:8,hi:12,rest:'1 min',baseLoad:12,defaultVid:'hammer_incline'},
    {sid:'C7',slot:'tri_push',muscle:M.TRICEPS,sets:3,lo:10,hi:15,rest:'1‚Äì2 min',baseLoad:16,defaultVid:'oh_ext'},
  ]},
  D:{title:'S√©ance D',sub:'Quadriceps ¬∑ Ischios ¬∑ Mollets',slots:[
    {sid:'D1',slot:'leg_press',muscle:M.QUADS,sets:4,lo:8,hi:12,rest:'2‚Äì3 min',baseLoad:140,defaultVid:'leg_press'},
    {sid:'D2',slot:'hip_hinge',muscle:M.HAMS,sets:3,lo:6,hi:10,rest:'2‚Äì3 min',baseLoad:70,defaultVid:'rdl_bar'},
    {sid:'D3',slot:'leg_curl',muscle:M.HAMS,sets:3,lo:10,hi:15,rest:'1.5‚Äì2 min',baseLoad:35,defaultVid:'leg_curl_seated'},
    {sid:'D4',slot:'leg_ext',muscle:M.QUADS,sets:3,lo:10,hi:15,rest:'1.5‚Äì2 min',baseLoad:35,defaultVid:'leg_ext'},
    {sid:'D5',slot:'calves',muscle:M.CALVES,sets:3,lo:12,hi:20,rest:'1‚Äì1.5 min',baseLoad:80,defaultVid:'calf_press'},
  ]},
};

// ============================
// Storage
// ============================
const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const jget=(k,f)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch{return f}};
const toNum=v=>{const n=parseFloat(String(v??''));return Number.isFinite(n)?n:NaN};

const LOG_KEY='paogramme_log_v2';
const CFG_KEY='paogramme_cfg_v2';
const LAST_KEY=(vid)=>`last_${vid}`;
const STATE_KEY=(vid)=>`state_${vid}`;
const RP10_KEY=(vid)=>`rp10_${vid}`;

const ACTIVE_SESS_KEY='paogramme_active_session_v1';
function getActiveSess(){ return localStorage.getItem(ACTIVE_SESS_KEY) || ''; }
function setActiveSess(L){ try{ localStorage.setItem(ACTIVE_SESS_KEY, String(L||'')); }catch{} }
function clearActiveSess(){ try{ localStorage.removeItem(ACTIVE_SESS_KEY); }catch{} }

function normalizeLog(raw){
  if(!raw) return [];
  if(Array.isArray(raw)) return raw.filter(Boolean);
  if(typeof raw==='object') return Object.values(raw).filter(Boolean);
  return [];
}
const getLog=()=>normalizeLog(jget(LOG_KEY,[]));
const setLog=(x)=>jset(LOG_KEY, normalizeLog(x));
const getCfg=()=>jget(CFG_KEY,{});
const setCfg=(x)=>jset(CFG_KEY,x);
const newId=()=>String(Date.now())+'_'+String(Math.random()).slice(2,9);

function getVariantForSlot(sid, defaultVid){
  const cfg=getCfg();
  return cfg[sid] || defaultVid;
}
function setVariantForSlot(sid, vid){
  const cfg=getCfg();
  cfg[sid]=vid;
  setCfg(cfg);
}

// effort
function effLabel(e){return e==='EASY'?'Facile':e==='HARD'?'Dur':'OK'}
function effToRir(e){return e==='EASY'?3:e==='HARD'?1:2}

// per-slot effort persists
const keyEff=(sid)=>`eff_${sid}`;
const getEff=(sid)=>jget(keyEff(sid),'OK');
function setEff(sid,eff){jset(keyEff(sid),eff); syncEff(sid)}
function syncEff(sid){
  const eff=getEff(sid);
  const wrap=document.getElementById('seg_'+sid);
  if(wrap){Array.from(wrap.querySelectorAll('button[data-eff]')).forEach(b=>b.classList.toggle('on',b.getAttribute('data-eff')===eff));}
  const lab=document.getElementById('eff_'+sid);
  if(lab) lab.textContent=effLabel(eff);
}

function toast(msg){
  const t=document.getElementById('toast');
  if(!t) return;
  t.textContent=msg; t.classList.add('on');
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.remove('on'),2200);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
}

function roundSmart(x){
  if(!Number.isFinite(x)) return x;
  if(x<20) return Math.round(x*2)/2;
  return Math.round(x);
}

// ============================
// RP10 helpers + coherent init load
// ============================
function getRP10(vid){ return toNum(localStorage.getItem(RP10_KEY(vid))); }
function setRP10(vid, val){
  if(!Number.isFinite(val) || val<=0){ localStorage.removeItem(RP10_KEY(vid)); }
  else localStorage.setItem(RP10_KEY(vid), String(val));
}
function estimateLoadFromRP10(rp10, repsTarget){
  const reps = Math.max(1, Math.round(repsTarget||10));
  const oneRM = rp10*(1+(10/30));
  const w = oneRM/(1+(reps/30));
  return w;
}
function suggestedStartLoad(slotDef, variant, targetRPS){
  const unit=(variant.unit||'kg');
  if(unit==='reps') return 0;
  const rp10 = getRP10(variant.vid);
  if(Number.isFinite(rp10) && rp10>0){
    return roundSmart(estimateLoadFromRP10(rp10, targetRPS));
  }
  return slotDef.baseLoad;
}

// ============================
// Time estimate
// ============================
function rtMarkDone(){
  const el=document.getElementById('rt');
  if(!el) return;
  el.classList.remove('done'); // reset animation if repeated
  // force reflow to restart animation
  void el.offsetWidth;
  el.classList.add('done');
  clearTimeout(rtMarkDone._tm);
  rtMarkDone._tm = setTimeout(()=>el.classList.remove('done'), 2200);
}

// Petit ‚Äúding‚Äù doux (WebAudio) : volume faible, fade-out, pas agressif.
// Fallback : vibration l√©g√®re si dispo.
function rtSoftBeep(){
  try{
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) throw new Error('no audio ctx');
    const ctx = new AC();

    const now = ctx.currentTime;

    function beep(freq, t, dur){
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.15, t + 0.02); // plus audible
      g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
      o.connect(g); g.connect(ctx.destination);
      o.start(t); o.stop(t + dur + 0.05);
    }

    // üîî Pattern type "fitness app" : double bip distinct
    beep(880, now, 0.35);        // premier bip
    beep(660, now + 0.45, 0.45); // second bip plus grave

    setTimeout(()=>{ try{ ctx.close(); }catch{} }, 1400);
  }catch(e){
    // fallback : vibration plus marqu√©e
    try{ navigator.vibrate?.([200,80,200]); }catch{}
  }
}

// ‚úÖ Boxing bell (sonnerie type ring de boxe) ‚Äî plus audible qu‚Äôun bip court
function rtBoxingBell(){
  try{
    const ok = rtUnlockAudio();
    const ctx = rtAudioCtx;
    if(!ok || !ctx) throw new Error('no audio');

    const now = ctx.currentTime;

    // Master gain (un peu plus pr√©sent, sans √™tre agressif)
    const out = ctx.createGain();
    out.gain.setValueAtTime(0.9, now);
    out.connect(ctx.destination);

    const bell = (freq, gain, decay, t0)=>{
      const o = ctx.createOscillator();
      const g = ctx.createGain();

      o.type = 'triangle';
      o.frequency.setValueAtTime(freq, t0);

      // enveloppe
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + decay);

      o.connect(g);
      g.connect(out);

      o.start(t0);
      o.stop(t0 + decay + 0.05);
    };

    // 3 impacts type ring (ding ding ding)
    const hit = (t, baseGain)=>{
      bell(880,  baseGain*0.18, 1.4, t);
      bell(1760, baseGain*0.08, 1.1, t);
      bell(1320, baseGain*0.05, 1.0, t);
      bell(2640, baseGain*0.03, 0.8, t);
    };

    hit(now, 1.0);
    hit(now + 0.35, 0.85);
    hit(now + 0.70, 0.70);

    setTimeout(()=>{ try{ out.disconnect(); }catch{} }, 2200);
  }catch(e){
    // Fallback : bip existant + vibration
    try{ rtSoftBeep(); }catch{}
    try{ navigator.vibrate?.([80,60,80,60,120]); }catch{}
  }
}


function parseRestMin(restStr){
  const s=String(restStr||'').toLowerCase().replace(/\s/g,'');
  const dash = s.includes('‚Äì') ? '‚Äì' : (s.includes('-') ? '-' : null);
  if(s.endsWith('s')){
    const n=parseFloat(s.replace('s',''));
    return Number.isFinite(n)? (n/60) : 1.5;
  }
  const x=s.replace('min','');
  if(dash){
    const [a,b]=x.split(dash).map(v=>parseFloat(v));
    if(Number.isFinite(a)&&Number.isFinite(b)) return (a+b)/2;
  }
  const n=parseFloat(x);
  return Number.isFinite(n)? n : 1.5;
}
function estimateSessionMinutes(L){
  return 50;
}

// ============================
// Rest Timer (linked to exercise rest)
// ============================
let rtState = {
  running:false,
  title:'Repos',
  sub:'‚Äî',
  totalSec:0,
  remainSec:0,
  endTs:0,
  tick:null,
  alarmTimeout:null,
  visible:false,
  finished:false,
  needsNotify:false,
};

const RT_STATE_KEY = 'paogramme_rt_state_v1';
function rtPersist(){
  try{
    const payload = {
      running: rtState.running,
      title: rtState.title,
      sub: rtState.sub,
      totalSec: rtState.totalSec,
      remainSec: rtState.remainSec,
      endTs: rtState.endTs,
      visible: rtState.visible,
      finished: rtState.finished,
      savedAt: Date.now(),
    };
    localStorage.setItem(RT_STATE_KEY, JSON.stringify(payload));
  }catch{}
}
function rtClearAlarm(){
  if(rtState.alarmTimeout){
    clearTimeout(rtState.alarmTimeout);
    rtState.alarmTimeout = null;
  }
}
function rtScheduleAlarm(){
  rtClearAlarm();
  if(!rtState.running || !rtState.endTs) return;
  const delay = Math.max(0, rtState.endTs - Date.now());
  rtState.alarmTimeout = setTimeout(()=>{
    if(!rtState.running) return;
    rtFinish();
  }, delay + 50);
}
function rtFinish(opts={}){
  const {silent=false, reason='' } = opts;
  if(rtState.finished) return;
  rtState.running = false;
  rtState.finished = true;
  rtState.remainSec = 0;
  rtState.endTs = 0;
  rtStopTick();
  rtClearAlarm();
  rtRender();
  rtMarkDone();
  if(!silent && rtGetSound()) rtBoxingBell();
  toast(reason ? `Repos termin√© ${reason}.` : 'Repos termin√©.');
  rtPersist();
}
function rtSyncNow(opts={}){
  if(!rtState.running || !rtState.endTs) return;
  const remain = Math.ceil((rtState.endTs - Date.now())/1000);
  rtState.remainSec = Math.max(0, remain);
  if(rtState.remainSec<=0){
    rtFinish(opts);
    return;
  }
  rtRender();
  rtScheduleAlarm();
  if(!rtState.tick) rtStartTick();
}
function rtRestore(){
  try{
    const raw = localStorage.getItem(RT_STATE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    if(!data || typeof data !== 'object') return;
    rtState.title = data.title || 'Repos';
    rtState.sub = data.sub || '‚Äî';
    rtState.totalSec = Math.max(0, Math.round(data.totalSec||0));
    rtState.visible = !!data.visible;
    rtState.finished = !!data.finished;
    if(data.running && data.endTs){
      rtState.endTs = data.endTs;
      const remain = Math.ceil((rtState.endTs - Date.now())/1000);
      rtState.remainSec = Math.max(0, remain);
      rtState.running = rtState.remainSec > 0;
      rtState.finished = false;
      rtState.needsNotify = rtState.remainSec <= 0;
    } else {
      rtState.running = false;
      rtState.endTs = 0;
      rtState.remainSec = Math.max(0, Math.round(data.remainSec||0));
    }
  }catch{}
}

// ‚úÖ Audio unlock (iOS/WKWebView) : garantit que WebAudio peut jouer un son √† la fin du chrono.
let rtAudioCtx = null;
function rtUnlockAudio(){
  try{
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return false;
    if(!rtAudioCtx) rtAudioCtx = new AC();
    if(rtAudioCtx.state === 'suspended') rtAudioCtx.resume?.();
    return true;
  }catch{ return false; }
}


function rtShow(show){
  const el=document.getElementById('rt');
  if(!el) return;
  el.classList.toggle('on', !!show);
  rtState.visible = !!show;

  // ‚úÖ Mobile ergonomie : quand le chrono est visible, on passe en "mode repos" (plein √©cran via CSS)
  document.body.classList.toggle('rt_full', !!show);
  rtPersist();
}
function rtFmt(sec){
  sec = Math.max(0, Math.round(sec||0));
  const m = Math.floor(sec/60);
  const s = sec%60;
  return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}
function rtRender(){
  const t=document.getElementById('rtTitle');
  const s=document.getElementById('rtSub');
  const c=document.getElementById('rtClock');
  const b=document.getElementById('rtToggle');
  if(t) t.textContent = rtState.title || 'Repos';
  if(s) s.textContent = rtState.sub || '‚Äî';
  if(c) c.textContent = rtFmt(rtState.remainSec);
  if(b) b.textContent = rtState.running ? 'Pause' : 'Start';
  rtUpdateSoundUI(); // ‚úÖ
}
function rtStopTick(){
  if(rtState.tick){ clearInterval(rtState.tick); rtState.tick=null; }
}
function rtStartTick(){
  rtStopTick();
  rtState.tick = setInterval(()=>{
    if(!rtState.running) return;
    const now=Date.now();
    const remain = Math.ceil((rtState.endTs - now)/1000);
    rtState.remainSec = Math.max(0, remain);
    rtRender();
    if(rtState.remainSec<=0){
      rtFinish();
    }

  }, 200);
}
function rtSet(sec, title, sub){
  rtState.totalSec = Math.max(0, Math.round(sec||0));
  rtState.remainSec = rtState.totalSec;
  rtState.title = title || 'Repos';
  rtState.sub = sub || '‚Äî';
  rtState.running = false;
  rtState.endTs = 0;
  rtState.finished = false;
  rtRender();
  rtShow(true);
  rtPersist();
}
function rtPlay(){
  rtUnlockAudio();
  if(rtState.remainSec<=0) rtState.remainSec = rtState.totalSec || 0;
  rtState.running = true;
  rtState.endTs = Date.now() + rtState.remainSec*1000;
  rtState.finished = false;
  rtRender();
  rtShow(true);
  rtStartTick();
  rtScheduleAlarm();
  rtPersist();
}
function rtPause(){
  if(!rtState.running) return;
  rtState.running = false;
  rtState.remainSec = Math.max(0, Math.ceil((rtState.endTs - Date.now())/1000));
  rtState.endTs = 0;
  rtState.finished = rtState.remainSec<=0;
  rtStopTick();
  rtClearAlarm();
  rtRender();
  rtPersist();
}
function rtToggle(){
  if(rtState.running) rtPause();
  else rtPlay();
}
function rtReset(){
  rtPause();
  rtState.remainSec = rtState.totalSec || 0;
  document.getElementById('rt')?.classList.remove('done');
  rtState.finished = false;
rtRender();
  rtPersist();
}
function rtAdd(deltaSec){
  const d = Math.round(deltaSec||0);

  // ‚úÖ Ajustement PONCTUEL : on ne modifie pas la dur√©e de base (totalSec)
  rtState.remainSec = Math.max(0, rtState.remainSec + d);

  if(rtState.running){
    rtState.endTs = Date.now() + rtState.remainSec*1000;
    rtScheduleAlarm();
  }
  rtRender();
  rtShow(true);
  rtPersist();
}
function rtClose(){
  rtPause();
  rtShow(false);
  rtPersist();
}

function getSlotDefBySid(sid){
  if(!current?.L) return null;
  const S=PROGRAM[current.L];
  return S?.slots?.find(x=>x.sid===sid) || null;
}
function startRestForSid(sid){
  const sd = getSlotDefBySid(sid);
  if(!sd) return;
  const restMin = parseRestMin(sd.rest);
  const sec = Math.round(restMin*60);
  const vid = getVariantForSlot(sd.sid, sd.defaultVid);
  const v = variantMeta(sd, vid);
  rtSet(sec, 'Repos', `${v.name} ‚Ä¢ ${sd.rest}`);
  rtPlay();
}
// ‚úÖ Sound preference (persistant)
const RT_SOUND_KEY = 'paogramme_rt_sound_v1';
function rtGetSound(){
  const v = localStorage.getItem(RT_SOUND_KEY);
  return v==null ? true : (v === '1');
}
function rtSetSound(on){
  localStorage.setItem(RT_SOUND_KEY, on ? '1' : '0');
}
function rtUpdateSoundUI(){
  const b = document.getElementById('rtSoundBtn');
  if(!b) return;
  const on = rtGetSound();
  b.textContent = on ? 'üîä' : 'üîá';
  b.title = on ? 'Son activ√©' : 'Son d√©sactiv√©';
  b.classList.toggle('on', on);
}
function rtToggleSound(){
  const on = !rtGetSound();
  rtSetSound(on);
  rtUpdateSoundUI();
  toast(on ? 'Son activ√©.' : 'Son d√©sactiv√©.');
}

// ============================
// Progression model
// ============================
function getLast(vid, fallbackLoad){
  const raw=jget(LAST_KEY(vid), null);

  if(raw && typeof raw==='object' && ('load' in raw) && !('performedLoad' in raw) && !('nextLoad' in raw)){
    const load = Number.isFinite(raw.load) ? raw.load : fallbackLoad;
    const nextRPS = Number.isFinite(raw.repsPerSet) ? raw.repsPerSet : null;
    return {
      performedLoad: load,
      performedTotalReps: Number.isFinite(raw.totalReps)?raw.totalReps:null,
      performedEff: raw.eff||'OK',
      performedTs: raw.ts||null,
      nextLoad: load,
      nextRepsPerSet: nextRPS,
    };
  }

  if(!raw){
    return {
      performedLoad: fallbackLoad,
      performedTotalReps: null,
      performedEff: 'OK',
      performedTs: null,
      nextLoad: null,
      nextRepsPerSet: null,
    };
  }

  return raw;
}
function setLast(vid, obj){ jset(LAST_KEY(vid), obj); }
function getState(vid){ return jget(STATE_KEY(vid), {failStreak:0}); }
function setState(vid, s){ jset(STATE_KEY(vid), s); }
function clampInt(x,a,b){ x=Math.round(x); return Math.max(a,Math.min(b,x)); }

function decideNext(slotDef, variant, actualTotalReps, eff, performedLoadToday){
  const sets=slotDef.sets;
  const lo=slotDef.lo, hi=slotDef.hi;
  const rir=effToRir(eff);
  const loTot=sets*lo, hiTot=sets*hi;

  const last=getLast(variant.vid, slotDef.baseLoad);
  const st=getState(variant.vid);

  const targetRPS = Number.isFinite(last.nextRepsPerSet) ? clampInt(last.nextRepsPerSet, lo, hi) : lo;

  const baseLoad = Number.isFinite(performedLoadToday) ? performedLoadToday
                  : (Number.isFinite(last.performedLoad) ? last.performedLoad : slotDef.baseLoad);

  const inRange = actualTotalReps >= loTot && actualTotalReps <= hiTot;
  const hitTop  = actualTotalReps >= hiTot;
  const belowMin = actualTotalReps < loTot;
  const okRir = rir >= 2;
  const hard = eff==='HARD';

  let action='MAINTIEN';
  let nextLoad=baseLoad;
  let nextRPS=targetRPS;
  let why=[];

  if(slotDef.note){
    action='MAINTIEN';
    why.push('Rappel technique: progression non obligatoire.');
    return {action,nextLoad,nextRPS,why};
  }

  if(belowMin){
    action='REMONT√âE';
    nextRPS = lo;
    st.failStreak = (st.failStreak||0)+1;
    why.push(`Sous le minimum (${actualTotalReps} < ${loTot}).`);
    why.push('On garde la charge et on remonte les reps.');
    setState(variant.vid, st);
    return {action,nextLoad,nextRPS,why};
  }

  if(hard){
    action='MAINTIEN';
    st.failStreak = (st.failStreak||0)+1;
    if(st.failStreak>=2 && targetRPS>lo){
      action='AJUSTEMENT';
      nextRPS = targetRPS-1;
      why.push('Effort: Dur (RIR bas).');
      why.push('Deux s√©ances difficiles: on baisse l√©g√®rement la cible reps.');
    } else {
      why.push('Effort: Dur ‚Üí on ne force pas la progression.');
    }
    setState(variant.vid, st);
    return {action,nextLoad,nextRPS,why};
  }

  st.failStreak = 0;

  if(hitTop && okRir){
    action='CHARGE +';
    const base=baseLoad;
    let inc = 1;

    if(variant.step!=null){
      inc = variant.step;
    } else if(variant.pct!=null){
      const raw = base*(variant.pct/100);
      inc = Math.max(0.5, Math.round(raw*2)/2);
    }
    nextLoad = roundSmart(base+inc);
    nextRPS = lo;
    why.push(`Haut de fourchette atteint (${actualTotalReps} ‚â• ${hiTot}).`);
    why.push('Effort OK ‚Üí micro-charge.');
    why.push(`Ensuite on repart sur ${lo} reps/s√©rie.`);
    setState(variant.vid, st);
    return {action,nextLoad,nextRPS,why};
  }

  if(inRange && targetRPS < hi){
    action='REPS +';
    nextRPS = clampInt(targetRPS+1, lo, hi);
    why.push(`Dans la fourchette (${loTot}‚Äì${hiTot}).`);
    why.push('Effort OK ‚Üí +1 rep par s√©rie la prochaine fois.');
    setState(variant.vid, st);
    return {action,nextLoad,nextRPS,why};
  }

  action='MAINTIEN';
  why.push('Continuit√© > performance ponctuelle.');
  setState(variant.vid, st);
  return {action,nextLoad,nextRPS,why};
}


function confirmLeaveSession(nextL){
  const active = getActiveSess();
  const curL = current?.L || active || '';
  if(!curL) return true;

  // si on clique la m√™me s√©ance, pas d‚Äôalerte
  if(curL===nextL) return true;

  const cur = PROGRAM[curL]?.title || 'S√©ance en cours';
  const nxt = PROGRAM[nextL]?.title || 'nouvelle s√©ance';
  return confirm(`Tu as une s√©ance en cours : "${cur}".

Pour l‚Äôenregistrer dans l‚Äôhistorique, il faut appuyer sur ‚ÄúTerminer ‚Ä¢ Enregistrer‚Äù.

Voulais-tu vraiment quitter "${cur}" pour passer √† "${nxt}" ?`);
}



let _leaveNextL = null;

function openLeaveSess(nextL){
  const active = getActiveSess();
  const curL = current?.L || active || '';
  if(!curL || curL===nextL){
    openSession(nextL);
    return;
  }

  _leaveNextL = nextL;

  const cur = PROGRAM[curL]?.title || curL;
  const nxt = PROGRAM[nextL]?.title || nextL;

  const s=document.getElementById('leaveS');
  const b=document.getElementById('leaveB');
  const go=document.getElementById('leaveGo');

  if(s) s.textContent = `S√©ance en cours : ${cur}`;
  if(b) b.innerHTML = `Tu es dans <b>${cur}</b>.<br><br>Voulais-tu vraiment quitter <b>${cur}</b> pour passer √† <b>${nxt}</b> ?<br><br><span class="small muted">Pour enregistrer dans l‚Äôhistorique : appuie sur <b>Terminer ‚Ä¢ Enregistrer</b>.</span>`;
  if(go) go.textContent = `Quitter et ouvrir ${nxt}`;

  document.getElementById('leaveSess')?.classList.add('on');
}

function closeLeaveSess(){
  document.getElementById('leaveSess')?.classList.remove('on');
  _leaveNextL = null;
}

function confirmLeaveSessGo(){
  const nextL = _leaveNextL;
  closeLeaveSess();
  if(nextL) openSession(nextL);
}


// ============================
// Views
// ============================
let current=null;
let focusOn=false;
// ============================
// In-session hint (Goals/Stats)
// ============================
function syncInSessionHints(){
  const on = !!(current && current.L);
  const txt = 'üü° <b>S√©ance en cours</b> ‚Äî Les exercices valid√©s sont conserv√©s. Appuie sur Terminer pour enregistrer la s√©ance dans l‚Äôhistorique.';
  const g = document.getElementById('hintGoals');
  const s = document.getElementById('hintStats');
  if(g){
    g.innerHTML = txt;
    g.style.display = on ? 'block' : 'none';
  }
  if(s){
    s.innerHTML = txt;
    s.style.display = on ? 'block' : 'none';
  }
}

let focusPickSid=null;
let focusSeance = true; // true = Focus s√©ance, false = Focus exercice


function show(view){
  document.getElementById('vHome').style.display=view==='home'?'block':'none';
  document.getElementById('vSession').style.display=view==='sess'?'block':'none';
  document.getElementById('vStats').style.display=view==='stats'?'block':'none';
  document.getElementById('vGoals').style.display=view==='goals'?'block':'none';
  document.getElementById('modePill').textContent =
    view==='stats' ? 'Analyse' :
    view==='goals' ? 'R√©f√©rences' : 'Simple';
  v3SetTab(view);
  window.scrollTo({top:0,behavior:'auto'});
}

// V3 tab highlight
function v3SetTab(view){
  const a=document.getElementById('sessionsBtn');
  const g=document.getElementById('goalsBtn');
  const s=document.getElementById('statsBtn');
  if(a) a.classList.toggle('on', view==='home' || view==='sess');
  if(g) g.classList.toggle('on', view==='goals');
  if(s) s.classList.toggle('on', view==='stats');
}

function goHome(){
  syncInSessionHints(); current=null; toggleFocus(false); closeSwap(); show('home'); renderHome(); }
function openSession(L){
  syncInSessionHints();
  setActiveSess(L);
  current={L};
  const S=PROGRAM[L];
  document.getElementById('sessTitle').innerHTML=`<span class="session-title-word">S√©ance</span><span class="session-letter">${L}</span>`;
  document.getElementById('btnDone').onclick=()=>openDone();
  document.getElementById('focusBtn').onclick=()=>{ focusSeance=true; focusPickSid=null; toggleFocus(true); };
  document.getElementById('sessMeta').textContent = `${S.sub} ~50 min`;
  renderSession(L);
  // ‚úÖ restauration brouillon si existant
  const d=loadDraft();
  if(d && Array.isArray(d)){
    for(const it of d){
      const r=document.getElementById('reps_'+it.sid);
      const l=document.getElementById('load_'+it.sid);
      if(r && it.repsTot!=null) r.value=it.repsTot;
      if(l && it.load!=null) l.value=it.load;
    }
  }
  show('sess');
}
function openStats(){
  syncInSessionHints(); renderStats(); show('stats'); }
function openGoals(){
  syncInSessionHints();
  renderGoals();
  show('goals');
  setTimeout(()=>document.getElementById('rp10Search')?.focus(), 50);
}

function renderHome(){
  const host=document.getElementById('homeCards');
  host.innerHTML='';
  ['A','B','C','D'].forEach(L=>{
    const S=PROGRAM[L];
    const t=estimateSessionMinutes(L);
    const b=document.createElement('button');
        b.className='card'; b.type='button'; b.onclick=()=>openLeaveSess(L);
    b.innerHTML=`<div class="k"><span class="session-title-word">S√©ance</span> <span class="session-letter">${L}</span></div><div class="s">${S.sub} ~${t} min</div>`;
    if(getActiveSess()===L){
      b.classList.add('active-session');
      b.insertAdjacentHTML('beforeend', `<div class="asBadge">üü° S√©ance en cours</div>`);
    }
    host.appendChild(b);
  });
}

function variantMeta(slotDef, vid){
  const list=CATALOG[slotDef.slot]||[];
  return list.find(x=>x.vid===vid) || list[0] || {vid,name:slotDef.slot,unit:'kg'};
}

// ============================
// Swap UI
// ============================
function openSwap(sid){
  if(!current?.L) return;
  const S=PROGRAM[current.L];
  const sd=S.slots.find(x=>x.sid===sid);
  if(!sd) return;
  const list=(CATALOG[sd.slot]||[]);

  const curVid=getVariantForSlot(sd.sid, sd.defaultVid);
  const cur=variantMeta(sd, curVid);

  document.getElementById('swapT').textContent = 'Choisir une variante';
  document.getElementById('swapS').textContent = `${sd.muscle} ‚Ä¢ ${sd.sets} s√©ries ‚Ä¢ Reps ${sd.lo}‚Äì${sd.hi}`;

  const host=document.getElementById('swapList');
  host.innerHTML = list.map(o=>{
    const on = o.vid===cur.vid;
    return `<button class="opt" type="button" onclick="pickSwap('${sd.sid}','${o.vid}')">
      ${on?'‚úÖ ':''}${escapeHtml(o.name)}
      <small>${escapeHtml(o.unit||'kg')}</small>
    </button>`;
  }).join('') || `<div class="small">Aucune variante disponible.</div>`;

  document.getElementById('swap').classList.add('on');
}
function closeSwap(){ document.getElementById('swap').classList.remove('on'); }
function pickSwap(sid, vid){
  setVariantForSlot(sid, vid);
  toast('Variante chang√©e. Historique conserv√© par exercice choisi.');
  if(current?.L) renderSession(current.L);
  closeSwap();
}

// ============================
// Session cards
// ============================
function exoCard(L, slotDef){
  const vid=getVariantForSlot(slotDef.sid, slotDef.defaultVid);
  const v=variantMeta(slotDef, vid);
  const last=getLast(v.vid, slotDef.baseLoad);
  const eff=getEff(slotDef.sid);

  const targetRPS = Number.isFinite(last.nextRepsPerSet) ? clampInt(last.nextRepsPerSet, slotDef.lo, slotDef.hi) : slotDef.lo;
  const unit = v.unit || 'kg';

  const performedLoad = Number.isFinite(last.performedLoad) ? last.performedLoad : slotDef.baseLoad;
  const initLoad = suggestedStartLoad(slotDef, v, targetRPS);
  const planLoad = Number.isFinite(last.nextLoad) ? last.nextLoad : initLoad;

  const lastLine = last.performedTs
    ? (unit==='reps'
        ? `Derni√®re : ${last.performedTotalReps??'‚Äî'} reps ¬∑ ${effLabel(last.performedEff||'OK')}`
        : `Derni√®re : ${last.performedTotalReps??'‚Äî'} reps ¬∑ ${performedLoad} ${unit} ¬∑ ${effLabel(last.performedEff||'OK')}`)
    : 'Derni√®re : ‚Äî';

  const goal = (unit==='reps')
    ? `${slotDef.sets}√ó${targetRPS} ‚Ä¢ Reps ${slotDef.lo}‚Äì${slotDef.hi}`
    : `${slotDef.sets}√ó${targetRPS} ‚Ä¢ Reps ${slotDef.lo}‚Äì${slotDef.hi} ‚Ä¢ ${planLoad} ${unit}`;

  return `
  <div class="exo" id="exo_${slotDef.sid}">
    <div class="small">${lastLine}</div>

    <div class="exoNameRow" style="margin-top:10px">
      <span class="swapBadge" title="Changer l‚Äôexercice" onclick="openSwap('${slotDef.sid}')">‚áÑ</span>
      <div style="flex:1">
        <button class="exoNameBtn" type="button" onclick="openSwap('${slotDef.sid}')">
          <div style="font-size:16px;font-weight:950;line-height:1.1">${escapeHtml(v.name)}</div>
          <div class="swapHint">Changer l‚Äôexercice</div>
        </button>
      </div>
    </div>

    <div class="meta">
      ${slotDef.muscle} ‚Ä¢ Repos ${slotDef.rest}
      <button class="btn ghost" type="button" style="margin-left:8px;padding:6px 10px" onclick="startRestForSid('${slotDef.sid}')">‚è± Repos</button>
      <button class="btn ghost" type="button" style="margin-left:8px;padding:6px 10px" onclick="openFocusForSid('${slotDef.sid}')">üéØ Focus</button>
    </div>

    <div class="goal">Objectif aujourd‚Äôhui ‚Ä¢ ${goal}</div>

    ${unit==='reps' ? `` : `
    <label>Charge utilis√©e aujourd‚Äôhui (${unit})
      <input id="load_${slotDef.sid}" type="number" value="${planLoad}" inputmode="decimal"/>
    </label>`}

    <label>Reps totales (${slotDef.sets} s√©ries)
      <input id="reps_${slotDef.sid}" type="number" placeholder="ex : ${slotDef.sets*slotDef.hi}" inputmode="numeric"/>
    </label>

    ${slotDef.note?`<div class="res">${escapeHtml(slotDef.note)}</div>`:`
      <div class="seg" id="seg_${slotDef.sid}">
        <button class="sbtn" data-eff="EASY" type="button" onclick="setEff('${slotDef.sid}','EASY')">üòå Facile</button>
        <button class="sbtn" data-eff="OK" type="button" onclick="setEff('${slotDef.sid}','OK')">üôÇ OK</button>
        <button class="sbtn" data-eff="HARD" type="button" onclick="setEff('${slotDef.sid}','HARD')">üò§ Dur</button>
      </div>
      <div class="small" style="margin-top:8px">Effort : <b id="eff_${slotDef.sid}">${effLabel(eff)}</b></div>
      <button class="btn" type="button" style="margin-top:12px" onclick="validate('${L}','${slotDef.sid}')">Valider</button>
      <div class="res" id="res_${slotDef.sid}"></div>
      <div class="why" id="why_${slotDef.sid}" style="display:none"></div>
    `}
  </div>`;
}

function renderSession(L){
  const S=PROGRAM[L];
  const host=document.getElementById('exoList');
  host.innerHTML = S.slots.map(sd=>exoCard(L,sd)).join('');
  S.slots.forEach(sd=>syncEff(sd.sid));
  if(focusOn) renderFocus();
}

// ============================
// Validate
// ============================
function validate(L, sid){
  const S=PROGRAM[L];
  const slotDef=S.slots.find(x=>x.sid===sid);
  if(!slotDef) return;

  if(slotDef.note){
    toast('Rappel technique: pas de validation/progression ici.');
    return;
  }

  const vid=getVariantForSlot(slotDef.sid, slotDef.defaultVid);
  const v=variantMeta(slotDef, vid);

  const unit=v.unit||'kg';
  const load = (unit==='reps') ? 0 : toNum(document.getElementById('load_'+sid)?.value);
  const totalReps=toNum(document.getElementById('reps_'+sid)?.value);
  const eff = getEff(sid);

  const res=document.getElementById('res_'+sid);
  const whyBox=document.getElementById('why_'+sid);

  if(!Number.isFinite(totalReps) || totalReps<=0){ if(res) res.textContent='Entre tes reps, puis valide.'; return; }
  if(unit!=='reps' && (!Number.isFinite(load))){ if(res) res.textContent='Charge invalide.'; return; }

  const rx=decideNext(slotDef, v, totalReps, eff, load);

  setLast(v.vid, {
    performedTs: Date.now(),
    performedLoad: load,
    performedTotalReps: totalReps,
    performedEff: eff,
    nextLoad: rx.nextLoad,
    nextRepsPerSet: rx.nextRPS,
  });

  const todayLine = (unit==='reps') ? `${totalReps} reps ¬∑ ${effLabel(eff)}` : `${totalReps} reps ¬∑ ${load} ${unit} ¬∑ ${effLabel(eff)}`;
  const nextLine  = (unit==='reps') ? `${slotDef.sets}√ó${rx.nextRPS}` : `${slotDef.sets}√ó${rx.nextRPS} ¬∑ ${rx.nextLoad} ${unit}`;

  if(res) res.textContent = `D√©cision : ${rx.action}\nAujourd‚Äôhui : ${todayLine}\nProchaine : ${nextLine}`;

  if(whyBox){
    whyBox.style.display='block';
    whyBox.innerHTML = `<b>Pourquoi</b><br>${rx.why.map(x=>'‚Ä¢ '+escapeHtml(x)).join('<br>')}`;
  }

  toast('OK. D√©cision coh√©rente et expliqu√©e.');
  // ‚úÖ sauvegarde brouillon s√©ance
  try{ saveDraft(buildSessionSnapshot(L)); }catch{}
  if(focusOn) renderFocus();
}

function openFocusForSid(sid){
  focusSeance=false;
  // ‚úÖ Permet de lancer le focus √† partir de l'exercice choisi
  focusPickSid = sid || null;
  if(!focusOn) toggleFocus(true);
  else renderFocus();
}

// ============================
// Focus mode
// ============================
function toggleFocus(on){
  focusOn=!!on;
  const el=document.getElementById('focus');
  el.classList.toggle('on',focusOn);
  // ‚úÖ On NE ferme PLUS le chrono en quittant le focus
  if(focusOn) renderFocus();
}


function renderFocus(){
  if(!current?.L) return;
  const S=PROGRAM[current.L];

  const actives = S.slots.filter(x=>!x.note);
  const totalAct = actives.length || 1;

  let next = actives[0] || S.slots[0];

  // ‚úÖ Focus EXO : verrouille l‚Äôexercice choisi. Focus S√âANCE : on suit la progression normale.
  if(!focusSeance && focusPickSid){
    const pick = S.slots.find(x=>x.sid===focusPickSid);
    if(pick) next = pick;
  }

  // Focus S√âANCE : on prend le prochain non rempli. Si tout est rempli, on reste sur le dernier.
  if(focusSeance){
    let todo = null;
    for(const sd of S.slots){
      if(sd.note) continue;
      const v=toNum(document.getElementById('reps_'+sd.sid)?.value);
      if(!Number.isFinite(v) || v<=0){ todo = sd; break; }
    }
    if(todo) next = todo;
    else next = actives[actives.length-1] || next;
  }
const vid=getVariantForSlot(next.sid,next.defaultVid);
  const v=variantMeta(next,vid);
  const last=getLast(v.vid,next.baseLoad);
  const unit=v.unit||'kg';

  const targetRPS=Number.isFinite(last.nextRepsPerSet)?clampInt(last.nextRepsPerSet,next.lo,next.hi):next.lo;
  const planLoad = Number.isFinite(last.nextLoad) ? last.nextLoad : suggestedStartLoad(next, v, targetRPS);

  const refLine = last.performedTs
    ? (unit==='reps'
        ? `${last.performedTotalReps||'‚Äî'} reps ¬∑ ${effLabel(last.performedEff||'OK')}`
        : `${last.performedTotalReps||'‚Äî'} reps ¬∑ ${last.performedLoad} ${unit} ¬∑ ${effLabel(last.performedEff||'OK')}`)
    : '‚Äî';

  document.getElementById('fTitle').textContent = v.name;
  const idxAct = Math.max(1, actives.findIndex(x=>x.sid===next.sid)+1);
  const isLastFocusSeance = (focusSeance===true) && (actives[actives.length-1]?.sid===next.sid) && actives.every(sd=>{const vv=toNum(document.getElementById('reps_'+sd.sid)?.value); return Number.isFinite(vv) && vv>0;});
  document.getElementById('fSub').textContent = `Focus ${focusPickSid?'(s√©lectionn√©)':'(auto)'} ‚Ä¢ Exo ${idxAct}/${totalAct} ‚Ä¢ ${next.muscle} ‚Ä¢ ${next.sets}√ó${targetRPS} ‚Ä¢ Reps ${next.lo}‚Äì${next.hi} ‚Ä¢ repos ${next.rest}`;

  const goalLine = (unit==='reps')
    ? `${next.sets}√ó${targetRPS} (Reps ${next.lo}‚Äì${next.hi})`
    : `${next.sets}√ó${targetRPS} (Reps ${next.lo}‚Äì${next.hi}) ¬∑ ${planLoad} ${unit}`;

  document.getElementById('fBody').innerHTML = `
    <div class="goal">Objectif ‚Ä¢ ${goalLine}</div>
    <div class="small" style="margin-top:8px">Derni√®re (r√©f√©rence) : ${refLine}</div>

    <label style="margin-top:12px">Reps totales
      <input id="f_reps" type="number" inputmode="numeric" placeholder="ex : ${next.sets*next.hi}" value="${document.getElementById('reps_'+next.sid)?.value||''}">
    </label>

    <button class="btn ghost" type="button" style="margin-top:10px" onclick="startRestForSid('${next.sid}')">‚è± Lancer le repos (${next.rest})</button>

    <div class="seg" style="margin-top:10px">
      <button class="sbtn" type="button" onclick="setEff('${next.sid}','EASY');toast('Effort: Facile');">üòå Facile</button>
      <button class="sbtn" type="button" onclick="setEff('${next.sid}','OK');toast('Effort: OK');">üôÇ OK</button>
      <button class="sbtn" type="button" onclick="setEff('${next.sid}','HARD');toast('Effort: Dur');">üò§ Dur</button>
    </div>

    <div class="row" style="margin-top:12px;justify-content:flex-start"><button class="btn" type="button" onclick="syncFocusToCard('${next.sid}');validate('${current.L}','${next.sid}')">Valider</button></div>
    ${isLastFocusSeance ? `
    <div style="margin-top:12px">
      <button class="btn" type="button" onclick="openDone()">Terminer ‚Ä¢ Enregistrer dans l‚Äôhistorique</button>
      <div class="small muted" style="margin-top:8px">Tous les exercices sont renseign√©s. Appuie sur ‚ÄúTerminer‚Äù pour l‚Äôajouter √† l‚Äôhistorique.</div>
    </div>
    ` : ``}

  `;
}
function syncFocusToCard(sid){
  const v=toNum(document.getElementById('f_reps')?.value);
  if(Number.isFinite(v)){
    const inp=document.getElementById('reps_'+sid);
    if(inp) inp.value=String(v);
  }
}

// ============================
// Goals page (RP10 table + search)
// ============================
let goalsQuery = '';
function normTxt(s){
  return String(s||'')
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ')
    .trim();
}
function setGoalsQuery(q){ goalsQuery = q || ''; renderGoals(); }

function allVariantsFlat(){
  const out=[];
  for(const [slot, list] of Object.entries(CATALOG)){
    for(const ex of (list||[])){
      out.push({slot, ...ex});
    }
  }
  return out;
}

function onRP10Input(vid, value){
  const n=toNum(value);
  setRP10(vid, n);
  toast('RP10 mis √† jour.');
  if(current?.L) renderSession(current.L);
}

function renderGoals(){
  const q = normTxt(goalsQuery);

  const all = allVariantsFlat();
  const items = all
    .slice()
    .sort((a,b)=> (a.slot+b.name).localeCompare(b.slot+a.name,'fr'))
    .filter(ex=>{
      if(!q) return true;
      const hay = normTxt(`${ex.name} ${ex.slot} ${ex.unit||''}`);
      return hay.includes(q);
    });

  const countTxt = q ? `${items.length} / ${all.length} exercices` : `${all.length} exercices`;
  const c = document.getElementById('rp10Count');
  if(c) c.textContent = countTxt;

  const rows = items.map(ex=>{
    const rp10 = getRP10(ex.vid);
    const disabled = (ex.unit||'kg')==='reps';
    const val = Number.isFinite(rp10) ? rp10 : '';
    const hint = disabled ? '‚Äî' : (Number.isFinite(rp10) ? `${roundSmart(estimateLoadFromRP10(rp10, 8))} kg @ 8 reps (est.)` : 'non renseign√©');
    return `<tr>
      <td style="width:46%"><b>${escapeHtml(ex.name)}</b><div class="small muted">${escapeHtml(ex.slot)}</div></td>
      <td style="width:120px">${escapeHtml(ex.unit||'kg')}</td>
      <td style="width:160px">
        <input ${disabled?'disabled':''} type="number" inputmode="decimal"
          placeholder="${disabled?'N/A':'ex : 80'}"
          value="${val}"
          oninput="onRP10Input('${ex.vid}', this.value)">
      </td>
      <td class="muted">${escapeHtml(hint)}</td>
    </tr>`;
  }).join('');

  document.getElementById('rp10Table').innerHTML = items.length ? `
    <div style="overflow:auto">
      <table>
        <thead>
          <tr><th>Exercice</th><th>Unit√©</th><th>RP10</th><th>Rep√®re</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  ` : `
    <div class="small" style="margin-top:10px">Aucun exercice ne correspond √† ‚Äú<b>${escapeHtml(goalsQuery)}</b>‚Äù.</div>
  `;

  const inp = document.getElementById('rp10Search');
  if(inp && inp.value !== goalsQuery) inp.value = goalsQuery;
}

// ============================
// Charts (canvas)
// ============================
function drawLineChart(canvasId, labels, seriesByName, opt){
  const c=document.getElementById(canvasId);
  if(!c) return;
  const ctx=c.getContext('2d');
  const W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);

  const pad={l:44,r:12,t:14,b:34};
  const x0=pad.l, y0=pad.t, x1=W-pad.r, y1=H-pad.b;

  const names=Object.keys(seriesByName);
  const allVals=[];
  for(const n of names){
    for(const v of seriesByName[n]){
      if(v==null && opt?.allowNull) continue;
      if(Number.isFinite(v)) allVals.push(v);
    }
  }
  const minV = allVals.length? Math.min(...allVals) : 0;
  const maxV = allVals.length? Math.max(...allVals) : 1;
  const span = (maxV-minV)||1;
  const lo = minV - span*0.08;
  const hi = maxV + span*0.08;

  const nX=Math.max(1,labels.length-1);
  const xAt=i=> x0 + (i/nX)*(x1-x0);
  const yAt=v=> y1 - ((v-lo)/(hi-lo))*(y1-y0);

  ctx.strokeStyle='rgba(255,213,106,.10)';
  ctx.lineWidth=1;
  for(let k=0;k<=4;k++){
    const y=y0 + (k/4)*(y1-y0);
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
  }
  for(let i=0;i<labels.length;i++){
    const x=xAt(i);
    ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y1); ctx.stroke();
  }

  ctx.fillStyle='rgba(255,255,255,.75)';
  ctx.font='12px ui-sans-serif,system-ui,-apple-system,Segoe UI';
  for(let k=0;k<=4;k++){
    const v=hi - (k/4)*(hi-lo);
    const y=y0 + (k/4)*(y1-y0);
    ctx.fillText(String(Math.round(v*10)/10), 8, y+4);
  }
  for(let i=0;i<labels.length;i++){
    const x=xAt(i);
    const txt=labels[i];
    ctx.save();
    ctx.translate(x, H-10);
    ctx.rotate(-Math.PI/8);
    ctx.fillText(txt, -18, 0);
    ctx.restore();
  }

  const pal=[
    'rgba(255,213,106,.95)',
    'rgba(212,175,55,.85)',
    'rgba(255,255,255,.85)',
    'rgba(255,213,106,.55)',
    'rgba(212,175,55,.55)'
  ];

  names.forEach((name,idx)=>{
    const arr=seriesByName[name];
    const col=pal[idx%pal.length];
    ctx.strokeStyle=col;
    ctx.lineWidth=2;
    ctx.beginPath();
    let started=false;
    for(let i=0;i<arr.length;i++){
      const v=arr[i];
      if(v==null && opt?.allowNull){ started=false; continue; }
      if(!Number.isFinite(v)) continue;
      const x=xAt(i), y=yAt(v);
      if(!started){ ctx.moveTo(x,y); started=true; }
      else ctx.lineTo(x,y);
    }
    ctx.stroke();

    ctx.fillStyle=col;
    for(let i=0;i<arr.length;i++){
      const v=arr[i];
      if(v==null && opt?.allowNull) continue;
      if(!Number.isFinite(v)) continue;
      const x=xAt(i), y=yAt(v);
      ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    }
  });

  ctx.fillStyle='rgba(255,213,106,.85)';
  ctx.font='12px ui-sans-serif,system-ui,-apple-system,Segoe UI';
  if(opt?.unit) ctx.fillText(opt.unit, W-48, 14);
}

// ============================
// Stats + History
// ============================
function startOfWeek(d){
  const x=new Date(d); x.setHours(0,0,0,0);
  const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day);
  return x;
}
function endOfWeek(d){
  const s=startOfWeek(d); const e=new Date(s);
  e.setDate(e.getDate()+6); e.setHours(23,59,59,999);
  return e;
}
function fmtDate(d){
  return new Date(d).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'});
}
function buildSessionSnapshot(L){
  const S=PROGRAM[L];
  const items=[];
  for(const sd of S.slots){
    const vid=getVariantForSlot(sd.sid,sd.defaultVid);
    const v=variantMeta(sd,vid);
    const unit=v.unit||'kg';
    const load = (unit==='reps') ? 0 : toNum(document.getElementById('load_'+sd.sid)?.value);
    const reps=toNum(document.getElementById('reps_'+sd.sid)?.value);
    const eff=getEff(sd.sid);
    const did=Number.isFinite(reps)&&reps>0;
    items.push({
      sid:sd.sid,slot:sd.slot,vid:v.vid,name:v.name,muscle:sd.muscle,
      sets:sd.sets,lo:sd.lo,hi:sd.hi,rest:sd.rest,unit,
      load:Number.isFinite(load)?load:null,
      repsTot:did?reps:null,
      eff:(did && !sd.note)?eff:null,
      note:!!sd.note
    });
  }
  return items;
}
function muscleWeightsForItem(it){
  if(it && Array.isArray(it.musclesW) && it.musclesW.length) return it.musclesW;

  const name=(it?.name||'').toLowerCase();
  const base=it?.muscle;

  // Poly-articulaires (heuristiques simples et prudentes)
  if(base===M.CHEST){
    if(/dips|d√©velopp|developp/.test(name)) return [[M.CHEST,0.70],[M.TRICEPS,0.30]];
  }
  if(base===M.BACK){
    if(/tirage|rowing|row|traction|pull/.test(name)) return [[M.BACK,0.75],[M.BICEPS,0.25]];
  }
  if(base===M.SHO){
    if(/d√©velopp|developp|militaire|arnold/.test(name)) return [[M.SHO,0.75],[M.TRICEPS,0.25]];
  }
  if(base===M.QUADS){
    if(/squat|presse|fente|hack|front/.test(name)) return [[M.QUADS,0.70],[M.HAMS,0.30]];
  }
  if(base===M.HAMS){
    if(/soulev|rdl|good|hip thrust|hip-hinge|leg\s*curl|curl\s*ischio/.test(name)) return [[M.HAMS,0.80],[M.QUADS,0.20]];
  }
  return base ? [[base,1]] : [];
}

function computeVolume(items){
  const out={};
  for(const it of (items||[])){
    const sets=(it?.sets||0);
    if(!sets) continue;
    const dist=muscleWeightsForItem(it);
    for(const [m,w] of dist){
      if(!m||!w) continue;
      out[m]=(out[m]||0)+sets*w;
    }
  }
  return out;
}

// ============================
// ‚úÖ Stats: rings helpers (minimal, stable)
// ============================

function seriesFmt(v){
  const n = Number(v)||0;
  const r = Math.round(n*10)/10;
  return (Math.abs(r - Math.round(r)) < 1e-9) ? String(Math.round(r)) : String(r);
}
function clamp01(x){ return Math.max(0, Math.min(1, x)); }

function ringOneSVG(pct, color){
  const p = clamp01(pct);
  const r = 26;
  const c = 2*Math.PI*r;
  const dash = (p*c);
  const gap = c - dash;
  const val = Math.round(p*100);
  return `
    <svg class="ringSvg" viewBox="0 0 72 72" aria-label="Progression ${val}%">
      <circle cx="36" cy="36" r="${r}" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="8"/>
      <circle cx="36" cy="36" r="${r}" fill="none" stroke="${color}" stroke-linecap="round"
        stroke-width="8"
        stroke-dasharray="${dash} ${gap}"
        transform="rotate(-90 36 36)"/>
      <text x="36" y="41" text-anchor="middle"
        font-family="ui-sans-serif,system-ui,-apple-system,Segoe UI"
        font-size="14" font-weight="950" fill="rgba(255,255,255,.92)">${val}%</text>
    </svg>
  `;
}

function appleMsgRhythm(p, sessions4){
  if(p>=1) return 'Rythme solide.';
  if(p>=0.80) return 'Tr√®s bon rythme.';
  if(p>=0.55) return 'Bon cap. Vise 3 s√©ances.';
  if(p>0) return 'Une s√©ance de plus change tout.';
  return 'Objectif : 3 s√©ances / semaine.';
}

function appleMsgIntensity(p, easySets, okSets, hardSets){
  const total = (easySets||0)+(okSets||0)+(hardSets||0);
  if(!total) return 'Valide 1 exo pour mesurer.';
  const hardPct = hardSets/Math.max(1,total);
  const easyPct = easySets/Math.max(1,total);
  if(p>=0.90) return 'Nickel. Continue.';
  if(hardPct>0.60) return 'Trop ‚ÄúDur‚Äù. R√©cup√®re.';
  if(easyPct>0.60) return 'Trop ‚ÄúFacile‚Äù. Charge +.';
  return 'Bien dos√©. Reste ‚ÄúOK‚Äù.';
}
function renderStats(){
  const log=getLog().slice().sort((a,b)=>b.ts-a.ts);
  const host=document.getElementById('hist');
  if(!log.length){
    document.getElementById('weekRange').textContent='‚Äî';
    document.getElementById('weekVol').innerHTML='<div class="small">Pas encore de stats.</div>';
    document.getElementById('trend').innerHTML='';
    host.innerHTML='<div class="small">Pas encore d‚Äôhistorique.</div>';
    return;
  }

  // ‚úÖ Semaine en cours (s√©ries par groupe)
  const now=new Date();
  const ws=startOfWeek(now), we=endOfWeek(now);
  document.getElementById('weekRange').textContent = `${fmtDate(ws)} ‚Üí ${fmtDate(we)}`;

  const weekly={};
  for(const e of log){
    if(e.ts<ws.getTime()||e.ts>we.getTime()) continue;
    for(const [k,v] of Object.entries(e.vol||{})) weekly[k]=(weekly[k]||0)+v;
  }

  const musclesList=[M.CHEST,M.BACK,M.BICEPS,M.TRICEPS,M.SHO,M.QUADS,M.HAMS,M.CALVES];
  const max=Math.max(1,...musclesList.map(m=>weekly[m]||0));

  document.getElementById('weekVol').innerHTML = `<table>${musclesList.map(m=>{
    const v=weekly[m]||0; const pct=Math.round((v/max)*100);
    return `<tr><th>${m}</th><td style="width:90px"><b>${seriesFmt(v)}</b> s√©ries</td><td><div class="bar"><i style="width:${pct}%"></i></div></td></tr>`;
  }).join('')}</table>`;

  // ‚úÖ R√©sum√© visuel (4 semaines glissantes)
  const winStart = Date.now() - 28*24*60*60*1000;

  // Rythme = s√©ances termin√©es (objectif 12 sur 4 semaines = 3 / semaine)
  const sessions4 = log.filter(e=>e.ts>=winStart).length;
  const pRhythm = Math.min(1, sessions4/12);

  // Intensit√© = pond√©ration des efforts (par s√©ries)
  let setsEasy4=0, setsOK4=0, setsHard4=0;
  for(const e of log){
    if(e.ts<winStart) continue;
    for(const it of (e.items||[])){
      if(it.repsTot==null) continue;
      if(it.note) continue;
      const s = Number.isFinite(it.sets)?it.sets:0;
      if(!s) continue;
      if(it.eff==='EASY') setsEasy4 += s;
      else if(it.eff==='HARD') setsHard4 += s;
      else if(it.eff==='OK') setsOK4 += s;
    }
  }
  const totalSets4 = setsEasy4+setsOK4+setsHard4;

  // Score simple: OK plein, HARD 0.9, EASY 0.6 (lisible + prudent)
  const intensityScore4 = totalSets4 ? ((setsOK4*1.0 + setsHard4*0.9 + setsEasy4*0.6) / totalSets4) : 0;
  const pInt = clamp01(intensityScore4);

  document.getElementById('trend').innerHTML = `
  <div class="rvMeta">Bas√© sur tes 4 derni√®res semaines ‚Ä¢ Objectif rythme : 3 s√©ances / semaine</div>

  <div class="rvGrid2">
    <div class="rvCard2">
      <div class="rvRing">${ringOneSVG(pRhythm,'rgba(255,77,77,.98)')}</div>
      <div class="rvLabel">Rythme</div>
      <div class="rvSmall">${sessions4} / 12 s√©ances</div>
      <div class="rvHint">${appleMsgRhythm(pRhythm, sessions4)}</div>
    </div>

    <div class="rvCard2">
      <div class="rvRing">${ringOneSVG(pInt,'rgba(246,200,82,.98)')}</div>
      <div class="rvLabel">Intensit√©</div>
      <div class="rvSmall">${Math.round(intensityScore4*100)}% qualit√©</div>
      <div class="rvHint">${appleMsgIntensity(pInt, setsEasy4, setsOK4, setsHard4)}</div>
    </div>
  </div>
`;

  // ‚úÖ Historique (inchang√©)
  host.innerHTML = log.slice(0,12).map(entry=>{
    const dt=new Date(entry.ts);
    const title = `<span class="session-letter">${entry.letter}</span> ‚Ä¢ ${dt.toLocaleDateString('fr-FR',{weekday:'short',day:'2-digit',month:'2-digit'})} ${dt.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
    const volTxt = Object.entries(entry.vol||{}).filter(([,v])=>v>0).map(([k,v])=>`${k}:${seriesFmt(v)}`).join(' ¬∑ ')||'‚Äî';

    const rows=(entry.items||[]).map(it=>{
      const did=it.repsTot!=null;
      const right=did
        ? (it.unit==='reps'
            ? `${it.repsTot} reps`
            : `${it.repsTot} reps ¬∑ ${it.load??'‚Äî'} ${it.unit||'kg'} ¬∑ ${it.eff?effLabel(it.eff):''}`)
        : `<span class="muted">non renseign√©</span>`;
      return `<tr>
        <td style="width:40%">${escapeHtml(it.name)}<div class="small muted">${escapeHtml(it.muscle||'')}</div></td>
        <td>${right}</td>
        <td style="width:140px"><input style="margin:0" type="number" placeholder="reps" value="${did?it.repsTot:''}" id="ed_reps_${entry.id}_${it.sid}"></td>
        <td style="width:160px"><input style="margin:0" type="number" placeholder="charge" value="${it.load??''}" id="ed_load_${entry.id}_${it.sid}"></td>
      </tr>`;
    }).join('');

    return `<details style="margin-top:10px">
      <summary>${title} <span class="muted">‚Ä¢ ${escapeHtml(volTxt)}</span></summary>
      <div class="small" style="margin-top:6px">Modifie reps/charge puis ‚ÄúEnregistrer‚Äù.</div>
      <div style="overflow:auto"><table><thead><tr><th>Exercice</th><th>R√©sultat</th><th>Reps</th><th>Charge</th></tr></thead><tbody>${rows}</tbody></table></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" type="button" onclick="saveEdit('${entry.id}')">Enregistrer</button>
        <button class="btn ghost" type="button" onclick="deleteEntry('${entry.id}')">Supprimer</button>
      </div>
    </details>`;
  }).join('');
}

function saveEdit(entryId){
  const log=getLog();
  const idx=log.findIndex(x=>x.id===entryId);
  if(idx<0) return;
  const entry=log[idx];
  const items=(entry.items||[]).map(it=>{
    const r=toNum(document.getElementById(`ed_reps_${entryId}_${it.sid}`)?.value);
    const l=toNum(document.getElementById(`ed_load_${entryId}_${it.sid}`)?.value);
    const reps = Number.isFinite(r)&&r>0 ? r : null;
    const load = Number.isFinite(l) ? l : (it.load??null);
    return {...it, repsTot: reps, load};
  });
  const vol=computeVolume(items);
  const total=Object.values(vol).reduce((a,b)=>a+b,0);
  log[idx]={...entry, items, vol, total};
  setLog(log);
  toast('Historique mis √† jour.');
  renderStats();
}
function deleteEntry(entryId){
  setLog(getLog().filter(x=>x.id!==entryId));
  toast('S√©ance supprim√©e.');
  renderStats();
}

// ============================
// ‚úÖ Import CSV (Aura Farm)
// ============================
function triggerImport(){
  const input = document.getElementById('importCsv');
  if(!input) return;
  input.value = '';
  input.click();
}

function parseCsv(text){
  const rows=[];
  let row=[];
  let field='';
  let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    const next=text[i+1];
    if(inQuotes){
      if(c === '"' && next === '"'){ field+='"'; i++; }
      else if(c === '"'){ inQuotes=false; }
      else{ field+=c; }
      continue;
    }
    if(c === '"'){ inQuotes=true; continue; }
    if(c === ';'){
      row.push(field);
      field='';
      continue;
    }
    if(c === '\n'){
      row.push(field);
      rows.push(row);
      row=[]; field='';
      continue;
    }
    if(c === '\r'){ continue; }
    field+=c;
  }
  row.push(field);
  if(row.length>1 || row[0]) rows.push(row);
  return rows;
}

function normalizeHeader(h){
  return String(h||'').replace(/^\uFEFF/,'').trim().toLowerCase();
}

function effFromLabel(label){
  const v=String(label||'').trim().toLowerCase();
  if(v==='facile') return 'EASY';
  if(v==='dur') return 'HARD';
  if(v==='ok') return 'OK';
  return null;
}

function parseFrDate(dateStr, timeStr){
  const d=String(dateStr||'').trim();
  const t=String(timeStr||'').trim();
  const [dd,mm,yyyy]=d.split('/').map(n=>parseInt(n,10));
  if(!Number.isFinite(dd)||!Number.isFinite(mm)||!Number.isFinite(yyyy)) return null;
  let hh=0, min=0;
  if(t){
    const parts=t.split(':');
    hh=parseInt(parts[0],10);
    min=parseInt(parts[1],10);
  }
  if(!Number.isFinite(hh)) hh=0;
  if(!Number.isFinite(min)) min=0;
  return new Date(yyyy, mm-1, dd, hh, min, 0, 0);
}

function importData(file){
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const text=String(reader.result||'');
    const rows=parseCsv(text).filter(r=>r.some(cell=>String(cell||'').trim()!==''));
    if(!rows.length){
      toast('Fichier CSV vide.');
      return;
    }
    const header=rows.shift();
    const map={};
    header.forEach((h,idx)=>{ map[normalizeHeader(h)] = idx; });
    const idxDate = map['date'];
    const idxTime = map['heure'];
    const idxLetter = map['s√©ance'] ?? map['seance'];
    const idxName = map['exercice'];
    const idxMuscle = map['groupe_musculaire'];
    const idxSets = map['s√©ries'] ?? map['series'];
    const idxRepsTarget = map['reps_cible'];
    const idxReps = map['reps_totales'];
    const idxLoad = map['charge'];
    const idxUnit = map['unit√©'] ?? map['unite'];
    const idxEff = map['effort'];
    const idxRest = map['repos'];

    if([idxDate, idxTime, idxLetter, idxName, idxReps].some(v=>v==null)){
      toast('CSV non reconnu. Exporte depuis Aura Farm.');
      return;
    }

    const existing=getLog();
    const existingKeys=new Set(existing.map(entry=>{
      const d=new Date(entry.ts);
      const pad=n=>String(n).padStart(2,'0');
      const keyDate=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const keyTime=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
      return `${entry.letter}_${keyDate}_${keyTime}`;
    }));

    const sessions=new Map();
    let importedRows=0;
    for(const row of rows){
      const dateStr=row[idxDate];
      const timeStr=row[idxTime];
      const letter=row[idxLetter] || '?';
      const name=row[idxName] || '';
      const repsVal=toNum(row[idxReps]);
      if(!name || !Number.isFinite(repsVal)) continue;
      const d=parseFrDate(dateStr, timeStr);
      if(!d) continue;
      const pad=n=>String(n).padStart(2,'0');
      const keyDate=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const keyTime=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
      const key=`${letter}_${keyDate}_${keyTime}`;
      if(existingKeys.has(key)) continue;

      if(!sessions.has(key)){
        sessions.set(key,{letter, ts:d.getTime(), items:[]});
      }

      const repsTarget=String(row[idxRepsTarget]||'').trim();
      let lo=null, hi=null;
      if(repsTarget.includes('-')){
        const parts=repsTarget.split('-').map(p=>toNum(p.trim()));
        lo=Number.isFinite(parts[0])?parts[0]:null;
        hi=Number.isFinite(parts[1])?parts[1]:null;
      }

      const unit = (row[idxUnit] || 'kg').trim() || 'kg';
      const load = unit==='reps' ? null : toNum(row[idxLoad]);
      const eff = effFromLabel(row[idxEff]);
      const note = String(row[idxEff]||'').trim().toLowerCase()==='rappel';

      sessions.get(key).items.push({
        sid:newId(),
        slot:null,
        vid:null,
        name:name,
        muscle:row[idxMuscle] || '',
        sets:toNum(row[idxSets]) || null,
        lo:lo,
        hi:hi,
        rest:toNum(row[idxRest]) || null,
        unit:unit,
        load:Number.isFinite(load)?load:null,
        repsTot:repsVal,
        eff:eff,
        note:note
      });
      importedRows++;
    }

    if(!sessions.size){
      toast('Aucune nouvelle s√©ance import√©e.');
      return;
    }

    const merged=[...existing];
    for(const entry of sessions.values()){
      const vol=computeVolume(entry.items);
      const total=Object.values(vol).reduce((a,b)=>a+b,0);
      merged.push({id:newId(), ts:entry.ts, letter:entry.letter, items:entry.items, vol, total});
    }
    setLog(merged);
    renderStats();
    toast(`${sessions.size} s√©ance(s) import√©e(s) (${importedRows} lignes).`);
  };
  reader.onerror=()=>toast('Lecture du CSV impossible.');
  reader.readAsText(file);
}

// ============================
// ‚úÖ Export CSV (unique bouton Exporter)
// ============================
function csvEscape(v){
  const s = String(v ?? '');
  if(/[;"\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function exportData(){
  const log = getLog().slice().sort((a,b)=>a.ts-b.ts);
  if(!log.length){
    toast('Aucune donn√©e √† exporter.');
    return;
  }

  const header = [
    'Date',
    'Heure',
    'S√©ance',
    'Exercice',
    'Groupe_musculaire',
    'S√©ries',
    'Reps_cible',
    'Reps_totales',
    'Charge',
    'Unit√©',
    'Effort',
    'Volume_estim√©',
    'Repos'
  ];
  const lines = [header.map(csvEscape).join(';')];

  for(const entry of log){
    const dt = new Date(entry.ts);
    const date = dt.toLocaleDateString('fr-FR');
    const heure = dt.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});

    for(const it of (entry.items||[])){
      if(it.repsTot == null) continue;

      const unit = it.unit || 'kg';
      const loadNum = (unit==='reps') ? null : (Number.isFinite(it.load) ? it.load : null);
      const volume = (loadNum!=null && Number.isFinite(it.repsTot)) ? Math.round(loadNum * it.repsTot * 10)/10 : '';

      const row = [
        date,
        heure,
        entry.letter,
        it.name || '',
        it.muscle || '',
        it.sets ?? '',
        (it.lo!=null && it.hi!=null) ? `${it.lo}-${it.hi}` : '',
        it.repsTot,
        loadNum!=null ? loadNum : '',
        unit,
        it.eff ? effLabel(it.eff) : (it.note ? 'Rappel' : ''),
        volume,
        it.rest || ''
      ];

      lines.push(row.map(csvEscape).join(';'));
    }
  }

  const csv = '\uFEFF' + lines.join('\n'); // BOM pour Excel
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);

  const d = new Date();
  const dateTag = d.toISOString().slice(0,10);
  const a = document.createElement('a');
  a.href = url;
  a.download = `paogramme_log_${dateTag}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  toast('Export CSV t√©l√©charg√©.');
}

// ============================
// Draft session (s√©curit√© UX)
// ============================
const DRAFT_KEY='paogramme_session_draft_v1';

function saveDraft(items){
  try{ localStorage.setItem(DRAFT_KEY, JSON.stringify(items)); }catch{}
}
function loadDraft(){
  try{ return JSON.parse(localStorage.getItem(DRAFT_KEY)||'null'); }catch{ return null }
}
function clearDraft(){ try{ localStorage.removeItem(DRAFT_KEY); }catch{} }

// ============================
// Finish session
// ============================
function openDone(){ document.getElementById('done').classList.add('on'); }
function closeDone(){
  if(current?.L){
    const L=current.L;
    const items=buildSessionSnapshot(L);
    const hasAny = items.some(it=>it.repsTot!=null);
    if(hasAny){
      const vol=computeVolume(items);
      const total=Object.values(vol).reduce((a,b)=>a+b,0);
      const entry={id:newId(),ts:Date.now(),letter:L,items,vol,total};
      clearDraft();
      const log=getLog(); log.push(entry); setLog(log);
    } else {
      toast('Aucune donn√©e saisie: s√©ance non enregistr√©e.');
      clearDraft();
    }
  }
  document.getElementById('done').classList.remove('on');
  clearActiveSess();
  goHome();
}

// ============================
// Onboarding
// ============================
const ONB_KEY='onb_done_v5';
let onbStep=0;
const ONB=[
  {t:'Aura Farm.',b:'Tu entres tes reps + effort (et la charge). Chaque s√©ance compte. Chaque progr√®s est clair.'},
  {t:'Repos',b:'Touche ‚è± Repos pour lancer un chronom√®tre li√© √† l‚Äôexercice.'},
  {t:'Objectifs',b:'Dans ‚ÄúObjectifs‚Äù, renseigne tes RP10 : charges de d√©part coh√©rentes m√™me sans historique.'},
];
function openOnb(){ const ov=document.getElementById('onb'); onbStep=0; renderOnb(); ov.classList.add('on'); }
function renderOnb(){
  const x=ONB[onbStep];
  document.getElementById('onbT').textContent=x.t;
  document.getElementById('onbB').textContent=x.b;
  document.getElementById('onbS').textContent=(onbStep+1)+'/3';
  document.getElementById('onbN').textContent=(onbStep===2)?'Commencer':'Continuer';
}
function skipOnb(){ closeOnb(); }
function nextOnb(){ if(onbStep<2){ onbStep++; renderOnb(); return; } closeOnb(); }
function closeOnb(){ document.getElementById('onb').classList.remove('on'); localStorage.setItem(ONB_KEY,'1'); }

// Boot
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('statsBtn').addEventListener('click',openStats);
  document.getElementById('goalsBtn').addEventListener('click',openGoals);
  document.getElementById('sessionsBtn').addEventListener('click',goHome);
  const importInput=document.getElementById('importCsv');
  if(importInput){
    importInput.addEventListener('change',(e)=>{
      const file=e.target.files && e.target.files[0];
      if(file) importData(file);
    });
  }

  show('home');
  renderHome();
  rtRestore();
  rtRender();
  if(rtState.visible) rtShow(true);
  if(rtState.needsNotify){
    rtFinish({silent:true, reason:'(pendant ton absence)'});
    rtState.needsNotify = false;
  } else if(rtState.running){
    rtSyncNow({silent:true, reason:'(pendant ton absence)'});
  }
  
  syncInSessionHints();
rtUpdateSoundUI();

  document.addEventListener('visibilitychange',()=>{
    if(!document.hidden){
      rtSyncNow({reason:'(pendant ton absence)'});
    }
  });
  window.addEventListener('focus',()=>{
    rtSyncNow({reason:'(pendant ton absence)'});
  });
  window.addEventListener('pageshow',()=>{
    rtSyncNow({reason:'(pendant ton absence)'});
  });
  window.addEventListener('pagehide', rtPersist);

  // ‚úÖ Micro animation : quand le bouton "Terminer" du bas entre dans l'√©cran, on le met en avant 1 fois
  try{
    const cta=document.getElementById('btnDoneBottom');
    if(cta && 'IntersectionObserver' in window){
      const io=new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting){
            cta.classList.remove('ctaPulse');
            void cta.offsetWidth; // restart animation
            cta.classList.add('ctaPulse');
            setTimeout(()=>cta.classList.remove('ctaPulse'), 2200);
            io.disconnect();
          }
        });
      }, {threshold:0.55});
      io.observe(cta);
    }
  }catch{}

  if(!localStorage.getItem(ONB_KEY)) openOnb();
});
</script>
</body>
</html>
